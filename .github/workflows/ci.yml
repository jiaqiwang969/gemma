name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Python 代码检查和测试
  python-lint:
    name: Python Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check code style with Black
        run: |
          black --check --diff apps/ contexts/ experiments/ scripts/ || true

      - name: Check import order with isort
        run: |
          isort --check-only --diff apps/ contexts/ experiments/ scripts/ || true

      - name: Lint with flake8
        run: |
          flake8 apps/ contexts/ experiments/ scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 apps/ contexts/ experiments/ scripts/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests
        run: |
          if [ -d tests ]; then pytest tests/ -v; fi
        continue-on-error: true

  # 前端静态文件检查
  frontend-check:
    name: Frontend Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check HTML files exist
        run: |
          echo "Checking static files..."
          test -f apps/webui/static/home.html && echo "✓ home.html"
          test -f apps/webui/static/index.html && echo "✓ index.html"
          test -f apps/webui/static/docs.html && echo "✓ docs.html"
          test -f apps/webui/static/pitch.html && echo "✓ pitch.html"

      - name: Validate HTML syntax
        run: |
          echo "HTML files found:"
          find apps/webui/static -name "*.html" -type f | head -10

  # 部署脚本检查
  deploy-check:
    name: Deploy Scripts Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check deploy scripts are executable
        run: |
          echo "Checking deploy scripts..."
          test -f apps/deploy_all.sh && echo "✓ deploy_all.sh"
          test -f apps/webui/deploy/setup_server.sh && echo "✓ setup_server.sh"
          test -f apps/webui/deploy/deploy.sh && echo "✓ deploy.sh"

      - name: Validate shell scripts (shellcheck)
        run: |
          sudo apt-get install -y shellcheck
          shellcheck apps/deploy_all.sh || true
          shellcheck apps/webui/deploy/*.sh || true

  # Flask 服务器测试
  webui-test:
    name: WebUI Server Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Flask dependencies
        run: |
          pip install flask flask-cors requests

      - name: Test WebUI server starts
        run: |
          cd apps/webui
          timeout 10 python -c "
          from server_lite import app
          print('Flask app created successfully')
          with app.test_client() as client:
              response = client.get('/api/status')
              print(f'Status endpoint: {response.status_code}')
              assert response.status_code == 200
          print('All tests passed!')
          "

  # 文档检查
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check README exists
        run: |
          test -f README.md && echo "✓ README.md exists"

      - name: Check README content
        run: |
          echo "README.md sections:"
          grep -E "^##" README.md | head -20

      - name: Check for broken internal links
        run: |
          # 检查 README 中的内部链接
          echo "Checking internal links..."
          grep -oE '\[.*\]\((apps/|docs/|contexts/)[^)]+\)' README.md | while read link; do
            path=$(echo "$link" | sed 's/.*(\(.*\))/\1/')
            if [ -e "$path" ]; then
              echo "✓ $path"
            else
              echo "✗ Missing: $path"
            fi
          done
