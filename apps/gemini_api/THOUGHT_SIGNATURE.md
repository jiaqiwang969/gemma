# Thought Signatures: AI ä»"æ¦‚ç‡é¢„æµ‹"å‘"é€»è¾‘å®ä½“"è¿›åŒ–çš„åˆ†æ°´å²­

## è®¾è®¡å“²å­¦

### ä»"æ— çŠ¶æ€"åˆ°"æœ‰çŠ¶æ€"çš„èŒƒå¼è½¬ç§»

ä¼ ç»Ÿ LLM åƒä¸€ä¸ªæ‚£æœ‰"çŸ­æœŸè®°å¿†ä¸§å¤±ç—‡"çš„å¤©æ‰ï¼šæ¯æ¬¡å¯¹è¯éƒ½è¦é‡æ–°é˜…è¯»"ç—…å†æœ¬"ï¼ˆå¯¹è¯å†å²ï¼‰æ¥æ‰¾å›çŠ¶æ€ã€‚

**Thought Signatures çš„æœ¬è´¨**ï¼šè®© AI å…·å¤‡çœŸæ­£çš„"å·¥ä½œè®°å¿†"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   ä¼ ç»Ÿå¯¹è¯å†å² (Text History)          æ€ç»´ç­¾å (Thought Signature)         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                                             â”‚
â”‚   ğŸ“„ çº¸ä¸Šçš„ä¼šè®®çºªè¦                    ğŸ§  å¤§è„‘ä¸­çš„ç¬æ—¶ç¥ç»ç”µä¿¡å·              â”‚
â”‚      â†“                                    â†“                                â”‚
â”‚   é‡æ–°é˜…è¯»ã€é‡æ–°ç†è§£                   çŠ¶æ€åŠ è½½ã€ç¬é—´å”¤é†’                    â”‚
â”‚      â†“                                    â†“                                â”‚
â”‚   å¯èƒ½äº§ç”Ÿæ–°çš„å¹»è§‰                     é€»è¾‘é“¾æ¡é”å®š                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AI çš„"çµé­‚æŒ‡çº¹"

æ€ç»´ç­¾åè¯æ˜äº† AI çš„æ€è€ƒä¸å†æ˜¯éšæœºçš„æ¦‚ç‡ç¢°æ’ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯ä»¥è¢«ï¼š
- **æ•è·** (Captured) - åœ¨æ¨ç†ç»“æŸæ—¶æå– KV Cache
- **ä¼ é€’** (Transferred) - ä½œä¸º Base64 ç­¾ååœ¨ç½‘ç»œé—´ä¼ è¾“
- **æ¢å¤** (Restored) - åœ¨ä¸‹ä¸€è½®å¯¹è¯ä¸­é‡æ–°åŠ è½½

## æŠ€æœ¯æ¶æ„

### å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: åº”ç”¨å±‚ç¼“å­˜ (Application Cache)                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚ â€¢ ä¿å­˜: prompt_context, response_text, function_call                        â”‚
â”‚ â€¢ ç‰¹ç‚¹: è½»é‡ã€å¿«é€Ÿã€æ— éœ€ç‰¹æ®Šä¾èµ–                                              â”‚
â”‚ â€¢ ç¼ºç‚¹: ä¸‹ä¸€è½®ä»éœ€é‡æ–°è®¡ç®— KV Cache                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: KV Cache æŒä¹…åŒ– (KV Cache Persistence)                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚ â€¢ æŠ€æœ¯: llama.cpp slot-save-path æˆ– LMCache                                 â”‚
â”‚ â€¢ ä¿å­˜: æ¨¡å‹çš„å®Œæ•´æ³¨æ„åŠ›çŠ¶æ€ (Attention States)                              â”‚
â”‚ â€¢ ç‰¹ç‚¹: çœŸæ­£çš„çŠ¶æ€æ¢å¤ï¼Œè·³è¿‡é‡å¤è®¡ç®—                                          â”‚
â”‚ â€¢ å­˜å‚¨: ç£ç›˜ .bin æ–‡ä»¶ æˆ– Redis                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: åˆ†å¸ƒå¼çŠ¶æ€åŒæ­¥ (Distributed State Sync) [æœªæ¥]                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚ â€¢ æŠ€æœ¯: LMCache + Redis Cluster                                             â”‚
â”‚ â€¢ åœºæ™¯: å¤š Agent åä½œã€è·¨è®¾å¤‡æ¼«æ¸¸                                            â”‚
â”‚ â€¢ ç‰¹ç‚¹: æ€ç»´ç­¾åæˆä¸º"é€»è¾‘æ¥åŠ›æ£’"                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç­¾åæ ¼å¼

## çœŸå® Gemini 3 API é€†å‘å·¥ç¨‹åˆ†æ

é€šè¿‡å¯¹çœŸå® Gemini 3 Pro Preview API çš„å“åº”è¿›è¡Œé€†å‘åˆ†æï¼Œæˆ‘ä»¬å‘ç°äº† thoughtSignature çš„çœŸå®æ ¼å¼ã€‚

### åŸå§‹æ•°æ®åˆ†æ

```
çœŸå® API è¯·æ±‚:
POST /v1beta/models/gemini-3-pro-preview:generateContent
Body: {"contents":[{"parts":[{"text":"hi"}]}], "generationConfig":{"thinkingConfig":{"thinkingLevel":"high"}}}

å“åº”ä¸­çš„ thoughtSignature:
Es4ECssEAXLI2nzgIFni+co5oD6tk6IHVHJw24OXDBeakEEpdFbMSjgUifqa9q0RcdhTDvq0wadj...

è§£ç åˆ†æ:
  Base64 é•¿åº¦: 792 chars
  è§£ç åå¤§å°: 593 bytes
  ç¬¬ä¸€ä¸ªå­—èŠ‚: 0x12
  æ ¼å¼: Google Protocol Buffer
```

### Protocol Buffer æ ¼å¼å‘ç°

**å…³é”®å‘ç°**: çœŸå® Gemini API ä½¿ç”¨ **Protocol Buffer** æ ¼å¼ï¼Œè€Œé JSONï¼

| ç‰¹æ€§ | å€¼ | è¯´æ˜ |
|------|-----|------|
| æ ¼å¼ | Protocol Buffer | Google å†…éƒ¨åºåˆ—åŒ–æ ¼å¼ |
| é¦–å­—èŠ‚ | `0x12` | Protobuf field 2, wire type 2 (length-delimited) |
| å¤§å° | ~593 bytes | åŒ…å«å®Œæ•´æ¨ç†çŠ¶æ€ |
| thoughtsTokenCount | 145 | çœŸå®çš„æ€è€ƒ token æ•°é‡ |

### äºŒè¿›åˆ¶ç»“æ„è§£æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çœŸå® Gemini API thoughtSignature äºŒè¿›åˆ¶ç»“æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Byte 0:     0x12 (field 2, wire type 2 = length-delimited)                â”‚
â”‚  Byte 1-N:   varint (payload é•¿åº¦)                                          â”‚
â”‚  Byte N+1:   payload å¼€å§‹                                                   â”‚
â”‚                                                                             â”‚
â”‚  Payload å†…éƒ¨ç»“æ„ (é€†å‘æ¨æµ‹):                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Field 1: ç‰ˆæœ¬å· (varint)                                            â”‚   â”‚
â”‚  â”‚ Field 2: æ—¶é—´æˆ³ (fixed64)                                           â”‚   â”‚
â”‚  â”‚ Field 3: ä¼šè¯/ç­¾å ID (string)                                      â”‚   â”‚
â”‚  â”‚ Field 4: çŠ¶æ€å“ˆå¸Œ (bytes) - KV Cache çŠ¶æ€çš„æ‘˜è¦                      â”‚   â”‚
â”‚  â”‚ Field 5: æ¨ç†çŠ¶æ€æ•°æ® (bytes) - å‹ç¼©çš„æ³¨æ„åŠ›çŠ¶æ€                     â”‚   â”‚
â”‚  â”‚ Field 6: HMAC ç­¾å (bytes) - é˜²ç¯¡æ”¹éªŒè¯                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  åå…­è¿›åˆ¶ç¤ºä¾‹ (å‰60å­—èŠ‚):                                                    â”‚
â”‚  12ce040acb040172c8da7ce02059e2f9ca39a03ead93a207547270db83970c179a...     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æˆ‘ä»¬çš„å®ç°æ–¹æ¡ˆ

æ¨¡æ‹ŸçœŸå® API çš„ Protocol Buffer æ ¼å¼ï¼š

```python
def generate_thought_signature(...) -> str:
    """ç”Ÿæˆä¸çœŸå® Gemini API æ ¼å¼å…¼å®¹çš„ thoughtSignature"""

    # æ„å»º Protobuf payload
    payload_parts = []

    # Field 1: ç‰ˆæœ¬ (varint) - 0x08 = field 1, wire type 0
    version = 2 if kv_cache_id else 1
    payload_parts.append(bytes([0x08, version]))

    # Field 2: æ—¶é—´æˆ³ (fixed64) - 0x11 = field 2, wire type 1
    payload_parts.append(bytes([0x11]))
    payload_parts.append(timestamp.to_bytes(8, 'little'))

    # Field 3: ç­¾å ID (string) - 0x1a = field 3, wire type 2
    sig_id_bytes = signature_id.encode()
    payload_parts.append(bytes([0x1a, len(sig_id_bytes)]))
    payload_parts.append(sig_id_bytes)

    # Field 4: çŠ¶æ€å“ˆå¸Œ (bytes) - 0x22 = field 4, wire type 2
    state_hash = hashlib.sha256(context.encode()).digest()
    payload_parts.append(bytes([0x22, len(state_hash)]))
    payload_parts.append(state_hash)

    # Field 5: å¡«å……æ•°æ® (æ¨¡æ‹ŸçœŸå® API çš„çŠ¶æ€æ•°æ®)
    padding_size = {"minimal": 64, "low": 128, "medium": 256, "high": 400}
    padding = os.urandom(padding_size[thinking_level])
    payload_parts.append(bytes([0x2a]) + encode_varint(padding_size))
    payload_parts.append(padding)

    # Field 6: HMAC ç­¾å (bytes) - 0x32 = field 6, wire type 2
    hmac_sig = hashlib.sha256(secret + payload).digest()
    payload_parts.append(bytes([0x32, len(hmac_sig)]))
    payload_parts.append(hmac_sig)

    # ç»„è£…æœ€ç»ˆç­¾å (å¤–å±‚åŒ…è£…)
    # 0x12 æ˜¯çœŸå® API ç­¾åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚
    final_payload = b''.join(payload_parts)
    signature_bytes = bytes([0x12]) + encode_varint(len(final_payload)) + final_payload

    return base64.b64encode(signature_bytes).decode()
```

### ç­¾åé•¿åº¦å¯¹æ¯”

| thinkingLevel | çœŸå® Gemini API | æœ¬åœ°å®ç° | åŒ¹é…åº¦ |
|---------------|-----------------|----------|--------|
| minimal | ~400 chars | ~200 chars | 50% |
| low | ~500 chars | ~300 chars | 60% |
| medium | ~650 chars | ~500 chars | 77% |
| high | ~792 chars | ~692 chars | **87%** |

### éªŒè¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        thoughtSignature éªŒè¯æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. Base64 è§£ç                                                              â”‚
â”‚     â†“                                                                       â”‚
â”‚  2. æ£€æµ‹æ ¼å¼ (æ£€æŸ¥é¦–å­—èŠ‚)                                                     â”‚
â”‚     â”œâ”€ 0x12 â†’ Protocol Buffer æ ¼å¼ (æ–°)                                     â”‚
â”‚     â””â”€ 0x7B '{' â†’ JSON æ ¼å¼ (å…¼å®¹æ—§ç‰ˆ)                                       â”‚
â”‚     â†“                                                                       â”‚
â”‚  3. è§£æ Protobuf å­—æ®µ                                                       â”‚
â”‚     â”œâ”€ æå– version (field 1)                                               â”‚
â”‚     â”œâ”€ æå– timestamp (field 2)                                             â”‚
â”‚     â”œâ”€ æå– sig_id (field 3)                                                â”‚
â”‚     â””â”€ éªŒè¯ HMAC ç­¾å (field 6)                                              â”‚
â”‚     â†“                                                                       â”‚
â”‚  4. æ£€æŸ¥æ—¶é—´æˆ³æœ‰æ•ˆæ€§ (TTL = 1 hour)                                          â”‚
â”‚     â†“                                                                       â”‚
â”‚  5. ä»å†…å­˜ç¼“å­˜æ¢å¤çŠ¶æ€ (é€šè¿‡ sig_id æŸ¥æ‰¾)                                     â”‚
â”‚     â†“                                                                       â”‚
â”‚  6. (å¯é€‰) æ¢å¤ KV Cache                                                     â”‚
â”‚     â””â”€ å¦‚æœ version = 2ï¼Œè°ƒç”¨ llama-server slot restore API                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protobuf Wire Types å‚è€ƒ

| Wire Type | å€¼ | ç”¨é€” | Tag ç¤ºä¾‹ |
|-----------|-----|------|----------|
| Varint | 0 | int32, int64, bool | `0x08` = field 1, varint |
| Fixed64 | 1 | fixed64, double | `0x11` = field 2, fixed64 |
| Length-delimited | 2 | string, bytes, embedded messages | `0x12` = field 2, length-delimited |
| Fixed32 | 5 | fixed32, float | - |

**Tag è®¡ç®—å…¬å¼**: `tag = (field_number << 3) | wire_type`

ç¤ºä¾‹:
- `0x08` = (1 << 3) | 0 = field 1, varint
- `0x12` = (2 << 3) | 2 = field 2, length-delimited
- `0x1a` = (3 << 3) | 2 = field 3, length-delimited

### ä¸ºä»€ä¹ˆçœŸå® API ç­¾åæ›´é•¿ï¼Ÿ

çœŸå® Gemini API çš„ thoughtSignature åŒ…å«æ›´å¤šæ•°æ®ï¼š

1. **çœŸå®çš„æ¨¡å‹çŠ¶æ€** - å‹ç¼©çš„ KV Cache æ‘˜è¦ã€æ³¨æ„åŠ›å±‚çŠ¶æ€å“ˆå¸Œ
2. **æ¨ç†è·¯å¾„ç¼–ç ** - æ¨¡å‹å†…éƒ¨çš„æ€è€ƒè·¯å¾„
3. **æ›´å¤šå®‰å…¨ç­¾å** - å¤šå±‚åŠ å¯†å’ŒéªŒè¯
4. **å…ƒæ•°æ®** - æ¨¡å‹ç‰ˆæœ¬ã€åŒºåŸŸä¿¡æ¯ç­‰

æˆ‘ä»¬çš„å®ç°é€šè¿‡éšæœºå¡«å…… (padding) æ¥æ¨¡æ‹Ÿè¿™äº›æ•°æ®çš„å¤§å°ï¼Œç¡®ä¿ç­¾åé•¿åº¦æ¥è¿‘çœŸå® API

## API å“åº”æ ¼å¼å¯¹é½

### å­—æ®µé¡ºåº (ä¸çœŸå® Gemini API å®Œå…¨ä¸€è‡´)

```json
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "å“åº”æ–‡æœ¬...",
            "thoughtSignature": "Ev..."
          }
        ],
        "role": "model"
      },
      "finishReason": "STOP",
      "index": 0
    }
  ],
  "usageMetadata": {
    "promptTokenCount": 8,
    "candidatesTokenCount": 131,
    "totalTokenCount": 246,
    "promptTokensDetails": [
      {
        "modality": "TEXT",
        "tokenCount": 8
      }
    ],
    "thoughtsTokenCount": 107
  },
  "modelVersion": "gemma-3n-local",
  "responseId": "mdBXabDkAcWtz7IPm5mXsQg"
}
```

### å­—æ®µé¡ºåºè§„åˆ™

**é¡¶å±‚å­—æ®µé¡ºåº:**
1. `candidates` - å€™é€‰å“åº”åˆ—è¡¨
2. `usageMetadata` - Token ä½¿ç”¨ç»Ÿè®¡
3. `modelVersion` - æ¨¡å‹ç‰ˆæœ¬
4. `responseId` - å“åº”å”¯ä¸€ ID

**usageMetadata å†…éƒ¨é¡ºåº:**
1. `promptTokenCount` - è¾“å…¥ token æ•°
2. `candidatesTokenCount` - è¾“å‡º token æ•°
3. `totalTokenCount` - æ€» token æ•°
4. `promptTokensDetails` - è¾“å…¥è¯¦æƒ… (å« modality)
5. `thoughtsTokenCount` - æ€è€ƒ token æ•°

**æ³¨æ„:** çœŸå® Gemini API å“åº”ä¸­**æ²¡æœ‰**ä»¥ä¸‹å­—æ®µ:
- `safetyRatings`
- `promptFeedback`

## æœªæ¥å±•æœ›

### 1. åˆ†å¸ƒå¼ Agent åä½œçš„"æ¥åŠ›æ£’"

```python
# Agent A å®Œæˆå¸‚åœºåˆ†æ
result_a = agent_a.analyze_market()
thought_sig_a = result_a.thought_signature

# Agent B æ¥æ”¶ç­¾åï¼Œç¬é—´ç†è§£ A çš„åˆ†ææ€è·¯
agent_b.load_thought_signature(thought_sig_a)
result_b = agent_b.continue_analysis()  # æ— éœ€é‡æ–°æ¨å¯¼
```

### 2. è·¨å¹³å°çš„"é€»è¾‘æ¼«æ¸¸"

```
æ‰‹æœºç«¯å¼€å§‹ç¼–ç¨‹ä»»åŠ¡
    â†“
AI æ­£åœ¨æ€è€ƒæ¶æ„
    â†“
å¯¼å‡º thought_signature
    â†“
ä¼ è¾“åˆ°ç”µè„‘ç«¯
    â†“
ç”µè„‘ç«¯ AI åŠ è½½ç­¾å
    â†“
æ— ç¼æ¥ç®¡"æ­£åœ¨æ€è€ƒä¸­"çš„å¤§è„‘
```

### 3. è°ƒè¯•ä¸å®¡è®¡çš„æ–°ç»´åº¦

æ€ç»´ç­¾åå°†æˆä¸º AI è¡Œä¸ºå®¡è®¡çš„å…³é”®ï¼š
- å›æº¯ AI åœ¨äº§ç”Ÿé”™è¯¯å†³ç­–æ—¶çš„ç²¾ç¡®é€»è¾‘çŠ¶æ€
- æ¯”å•çº¯åˆ†ææ–‡å­—è¾“å‡ºæ·±åˆ»å¾—å¤š
- å¯éªŒè¯çš„æ¨ç†é“¾æ¡

## å®ç°å‚è€ƒ

| æ–¹æ¡ˆ | æŠ€æœ¯æ ˆ | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|
| llama.cpp slot-save | llama-server | å•æœºå¼€å‘/æµ‹è¯• |
| LMCache + Redis | vLLM | ç”Ÿäº§ç¯å¢ƒ/åˆ†å¸ƒå¼ |
| åº”ç”¨å±‚ç¼“å­˜ | Flask/FastAPI | Fallback/è½»é‡åœºæ™¯ |

## æ ¸å¿ƒä»£ç 

```python
# ç”Ÿæˆæ€ç»´ç­¾å (ä¿å­˜çŠ¶æ€)
signature = generate_thought_signature(
    prompt_context=full_prompt,
    response_text=response,
    function_call=fc,
    thinking_level="high",
    slot_id=0
)

# éªŒè¯å¹¶æ¢å¤çŠ¶æ€
state = validate_thought_signature(signature)
if state and state.get("kv_cache_restored"):
    # KV Cache å·²æ¢å¤ï¼Œè·³è¿‡é‡å¤è®¡ç®—
    print("Thought state restored from KV Cache")
```

## æµ‹è¯•éªŒè¯ç»“æœ

### å…¨é¢å…¼å®¹æ€§æµ‹è¯• (2025-01)

ä½¿ç”¨ `test_comparison.py` å¯¹æ¯”çœŸå® Gemini API ä¸æœ¬åœ°æœåŠ¡å™¨ï¼š

```
æµ‹è¯•æ€»ç»“
================================================================================
  âœ… 1.1 çº¯æ–‡æœ¬ç”Ÿæˆ: 18/18 é€šè¿‡
  âœ… 1.2 æ€è€ƒç­‰çº§ low: 18/18 é€šè¿‡
  âœ… 1.3 æ€è€ƒç­‰çº§ high: 15/15 é€šè¿‡
  âœ… 1.4 ç³»ç»ŸæŒ‡ä»¤: 15/15 é€šè¿‡
  âœ… 1.5 JSON Schema: 15/15 é€šè¿‡
  âœ… 1.6 å¤šè½®å¯¹è¯: 15/15 é€šè¿‡
  âœ… 2.1 å·¥å…·è°ƒç”¨ Step1: 18/18 é€šè¿‡
  âœ… 2.2 å·¥å…·è°ƒç”¨ Step2: 5/5 é€šè¿‡

æ€»è®¡: 119/119 æ£€æŸ¥é€šè¿‡
é€šè¿‡ç‡: 100.0%
```

### éªŒè¯é¡¹ç›®

| ç±»åˆ« | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|------|--------|------|
| é¡¶å±‚å­—æ®µ | candidates, usageMetadata, modelVersion, responseId | âœ… |
| å­—æ®µé¡ºåº | ä¸çœŸå® API å®Œå…¨ä¸€è‡´ | âœ… |
| usageMetadata | promptTokenCount, candidatesTokenCount, totalTokenCount, promptTokensDetails, thoughtsTokenCount | âœ… |
| thoughtSignature | Protocol Buffer æ ¼å¼, é¦–å­—èŠ‚ 0x12, é•¿åº¦ >50% | âœ… |
| å·¥å…·è°ƒç”¨ | functionCall + finishMessage | âœ… |

### è¿è¡Œæµ‹è¯•

```bash
# å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
python apps/gemini_api/server.py

# è¿è¡Œå¯¹æ¯”æµ‹è¯• (éœ€è¦æœ‰æ•ˆçš„ REAL_API_KEY)
python apps/gemini_api/test_comparison.py
```

## å‚è€ƒèµ„æ–™

- [LMCache GitHub](https://github.com/LMCache/LMCache)
- [llama.cpp KV Cache Tutorial](https://github.com/ggml-org/llama.cpp/discussions/13606)
- [vLLM Prefix Caching](https://docs.vllm.ai/en/latest/examples/others/lmcache/)
- [Google Gemini Thought Signatures](https://ai.google.dev/gemini-api/docs/thought-signatures)

---

> **æ€ç»´ç­¾åè®© AI æ‹¥æœ‰äº†"è¿‡å»"ï¼Œä»è€Œè®©å®ƒåœ¨å¤„ç†"æœªæ¥"æ—¶æ›´åŠ åšå®šã€‚**
