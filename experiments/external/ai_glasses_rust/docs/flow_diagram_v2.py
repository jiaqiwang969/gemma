"""
═══════════════════════════════════════════════════════════════════════════════════════
         AI 眼镜系统 - V-JEPA2 + Gemma 3n 协作流程图 (V2 - Cambrian-S 增强版)
═══════════════════════════════════════════════════════════════════════════════════════

核心升级: 融合 Cambrian-S 的 "惊讶度驱动" 机制
- 潜在帧预测 (Latent Frame Prediction, LFP)
- 违反预期检测 (Violation-of-Expectation, VoE)
- 选择性压缩与长期记忆
- 事件分割 (Event Segmentation)


┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   用户交互层                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    👤 用户                                                                          │
│      │                                                                              │
│      │  语音/文字查询: "这里面有几台笔记本电脑？"                                      │
│      ▼                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                          意图分析模块                                        │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  输入: 用户查询文本                                                  │    │    │
│  │  │  处理: 关键词匹配 + 语义分析                                          │    │    │
│  │  │  输出:                                                               │    │    │
│  │  │    - 意图类型: COUNT (计数)                                          │    │    │
│  │  │    - 置信度: 95%                                                     │    │    │
│  │  │    - 匹配关键词: ["几", "几台"]                                       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│      │                                                                              │
│      │  意图类型                                                                    │
│      ▼                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │
┌───────────────────────────────────────┼─────────────────────────────────────────────┐
│                                       ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     意图 → V-JEPA2 策略映射                                  │    │
│  ├─────────────────────────────────────────────────────────────────────────────┤    │
│  │                                                                             │    │
│  │   意图类型          │  V-JEPA2 提取策略        │  惊讶度阈值  │  说明         │    │
│  │  ──────────────────────────────────────────────────────────────────────────│    │
│  │   COUNT (计数)      │  SURPRISE_CLUSTER       │  0.10       │  惊讶聚类     │    │
│  │   LOCATE (定位)     │  SURPRISE_PEAK          │  0.15       │  惊讶峰值     │    │
│  │   COMPARE (对比)    │  EVENT_BOUNDARY         │  0.25       │  事件边界     │    │
│  │   DESCRIBE (描述)   │  UNIFORM_SURPRISE       │  0.08       │  均匀惊讶     │    │
│  │   TRACK (跟踪)      │  CONTINUOUS_PREDICT     │  0.05       │  连续预测     │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                             │
│                                       │  策略: SURPRISE_CLUSTER, 阈值: 0.10        │
│                                       ▼                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │
╔═════════════════════════════════════════════════════════════════════════════════════╗
║                    V-JEPA2 处理模块 (Cambrian-S 增强版)                              ║
╠═════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                     ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │              1. 流式编码 + 潜在帧预测 (LFP)                                   │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   📹 视频流 (实时/离线)                                                 │  │   ║
║  │  │      │                                                                 │  │   ║
║  │  │      ▼                                                                 │  │   ║
║  │  │   ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐                         │  │   ║
║  │  │   │帧 1 │  │帧 2 │  │帧 3 │  │帧 4 │  │帧 5 │  ...                    │  │   ║
║  │  │   └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘                         │  │   ║
║  │  │      │        │        │        │        │                             │  │   ║
║  │  │      ▼        ▼        ▼        ▼        ▼                             │  │   ║
║  │  │   ╔═════════════════════════════════════════════════════════════╗      │  │   ║
║  │  │   ║                    V-JEPA2 编码器                           ║      │  │   ║
║  │  │   ║                   (ViT-L, 1024维)                           ║      │  │   ║
║  │  │   ╠═════════════════════════════════════════════════════════════╣      │  │   ║
║  │  │   ║  ┌─────────────────────────────────────────────────────┐    ║      │  │   ║
║  │  │   ║  │      潜在帧预测头 (LFP Head) ← Cambrian-S 核心       │    ║      │  │   ║
║  │  │   ║  │                                                     │    ║      │  │   ║
║  │  │   ║  │   E(t) ───▶ LFP ───▶ Ê(t+1) (预测下一帧 embedding)  │    ║      │  │   ║
║  │  │   ║  │                                                     │    ║      │  │   ║
║  │  │   ║  └─────────────────────────────────────────────────────┘    ║      │  │   ║
║  │  │   ╚═════════════════════════════════════════════════════════════╝      │  │   ║
║  │  │      │        │        │        │        │                             │  │   ║
║  │  │      ▼        ▼        ▼        ▼        ▼                             │  │   ║
║  │  │   [E₁]     [E₂]     [E₃]     [E₄]     [E₅]     (实际 embedding)       │  │   ║
║  │  │      │        │        │        │        │                             │  │   ║
║  │  │      │    [Ê₂]    [Ê₃]    [Ê₄]    [Ê₅]         (预测 embedding)       │  │   ║
║  │  │      │        │        │        │        │                             │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                       │                                             ║
║                                       ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │           2. 惊讶度计算 (Violation-of-Expectation, VoE)                       │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │  惊讶度 = 1 - cosine_similarity(Ê(t), E(t))                     │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │  对比: 旧方案 vs 新方案                                          │  │  │   ║
║  │  │   │  ─────────────────────────────────────────────────────────────  │  │  │   ║
║  │  │   │  旧: 变化分数 = 1 - cos(E(t), E(t+1))    ← 帧间差异             │  │  │   ║
║  │  │   │  新: 惊讶度   = 1 - cos(Ê(t), E(t))      ← 预测误差 (更智能!)   │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   预测 vs 实际:                                                         │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   [Ê₂]    [Ê₃]    [Ê₄]    [Ê₅]     (V-JEPA2 预测的 embedding)         │  │   ║
║  │  │     ↕       ↕       ↕       ↕                                          │  │   ║
║  │  │   [E₂]    [E₃]    [E₄]    [E₅]     (实际观察到的 embedding)           │  │   ║
║  │  │     │       │       │       │                                          │  │   ║
║  │  │   0.03    0.05    0.32    0.04     (惊讶度分数)                        │  │   ║
║  │  │                     ↑                                                  │  │   ║
║  │  │              [高惊讶度!]                                                │  │   ║
║  │  │           预测与实际差异大                                              │  │   ║
║  │  │         = 出现了"意料之外"的内容                                        │  │   ║
║  │  │         = 可能是新物体/场景变化                                         │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   输出: surprise_scores = [0.0, 0.03, 0.05, 0.32, 0.04]               │  │   ║
║  │  │         event_boundaries = [4]  (帧4是事件边界)                        │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                       │                                             ║
║                                       ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │               3. 惊讶度驱动的选择性处理 (Surprise-Driven Selection)           │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   阈值: surprise_threshold = 0.10 (由意图决定)                         │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   帧1      帧2      帧3      帧4      帧5                        │  │  │   ║
║  │  │   │   S=0.00   S=0.03   S=0.05   S=0.32   S=0.04                    │  │  │   ║
║  │  │   │     │        │        │        │        │                       │  │  │   ║
║  │  │   │     ▼        ▼        ▼        ▼        ▼                       │  │  │   ║
║  │  │   │   ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐                       │  │  │   ║
║  │  │   │   │ 首帧 │  │ 低  │  │ 低  │  │ 高★│  │ 低  │                       │  │  │   ║
║  │  │   │   │ 保留 │  │惊讶│  │惊讶│  │惊讶│  │惊讶│                       │  │  │   ║
║  │  │   │   └──┬─┘  └──┬─┘  └──┬─┘  └──┬─┘  └──┬─┘                       │  │  │   ║
║  │  │   │      │        │        │        │        │                       │  │  │   ║
║  │  │   │      ▼        ▼        ▼        ▼        ▼                       │  │  │   ║
║  │  │   │   ┌────────────────────────────────────────────────────────┐    │  │  │   ║
║  │  │   │   │                                                        │    │  │  │   ║
║  │  │   │   │  关键帧缓冲区 (Key Frame Buffer):                       │    │  │  │   ║
║  │  │   │   │    [帧1: 首帧, S=0.0] [帧4: 高惊讶, S=0.32]             │    │  │  │   ║
║  │  │   │   │                                                        │    │  │  │   ║
║  │  │   │   │  长期记忆 (Long-term Memory) - 压缩存储:                 │    │  │  │   ║
║  │  │   │   │    [帧2: 2x压缩] [帧3: 2x压缩] [帧5: 2x压缩]            │    │  │  │   ║
║  │  │   │   │                                                        │    │  │  │   ║
║  │  │   │   └────────────────────────────────────────────────────────┘    │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   关键洞察 (来自 Cambrian-S):                                           │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │  "人类不会保留每一个视觉细节，而是学习生成过程，                   │  │  │   ║
║  │  │   │   用预测误差来定义什么是重要的"                                    │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │  高惊讶度 = 预期被违反 = 需要关注的"意外"内容                      │  │  │   ║
║  │  │   │  低惊讶度 = 预期符合 = 冗余信息，可压缩                            │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                       │                                             ║
║                                       ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                    4. 事件分割 + 语义聚类 (Event Segmentation)                 │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   事件边界检测 (高惊讶度帧自动成为分割点):                               │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌───────────────────────────────────────────────────────────────┐    │  │   ║
║  │  │   │                                                               │    │  │   ║
║  │  │   │   时间线: ─────────────────────────────────────────────────▶   │    │  │   ║
║  │  │   │           0s    2s    4s    6s    8s                          │    │  │   ║
║  │  │   │                                                               │    │  │   ║
║  │  │   │   惊讶度: ▁▁▁▁▂▂▂▂▃▃▃▃█████▂▂▂▂                              │    │  │   ║
║  │  │   │                        ↑                                      │    │  │   ║
║  │  │   │                   事件边界                                     │    │  │   ║
║  │  │   │                   (S=0.32)                                    │    │  │   ║
║  │  │   │                                                               │    │  │   ║
║  │  │   │   ┌──────────────┐    │    ┌──────────────┐                   │    │  │   ║
║  │  │   │   │   事件 A     │    │    │   事件 B     │                   │    │  │   ║
║  │  │   │   │  (MacBook)   │    │    │   (Dell)     │                   │    │  │   ║
║  │  │   │   │  帧1, 帧2, 帧3 │    │    │  帧4, 帧5    │                   │    │  │   ║
║  │  │   │   └──────────────┘    │    └──────────────┘                   │    │  │   ║
║  │  │   │                                                               │    │  │   ║
║  │  │   └───────────────────────────────────────────────────────────────┘    │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   事件内聚类 (在每个事件段内进行精细聚类):                               │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   事件 A (0s-5s):  K-Means → 1 个聚类 (同一台 MacBook)                  │  │   ║
║  │  │   事件 B (5s-9s):  K-Means → 1 个聚类 (同一台 Dell)                     │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   输出:                                                                 │  │   ║
║  │  │     events = [                                                         │  │   ║
║  │  │       {id: A, start: 0.0s, end: 5.0s, center_frame: 帧1},              │  │   ║
║  │  │       {id: B, start: 5.0s, end: 9.0s, center_frame: 帧4}               │  │   ║
║  │  │     ]                                                                  │  │   ║
║  │  │     n_distinct_objects = 2 (两个事件 = 可能两个不同物体)                │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                       │                                             ║
║                                       ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                      5. V-JEPA2 分析结果汇总 (增强版)                          │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   VJEPAAnalysis (v2):                                                  │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   # 基础信息                                                            │  │   ║
║  │  │     - key_frames: [帧1, 帧4]            (高惊讶度帧)                    │  │   ║
║  │  │     - compressed_frames: [帧2, 帧3, 帧5] (低惊讶度，已压缩)             │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   # 惊讶度分析 (新增)                                                    │  │   ║
║  │  │     - surprise_scores: [0.0, 0.03, 0.05, 0.32, 0.04]                   │  │   ║
║  │  │     - max_surprise: 0.32 (帧4)                                         │  │   ║
║  │  │     - mean_surprise: 0.088                                             │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   # 事件分割 (新增)                                                      │  │   ║
║  │  │     - event_boundaries: [5.0s]                                         │  │   ║
║  │  │     - events: [事件A (0-5s), 事件B (5-9s)]                              │  │   ║
║  │  │     - n_events: 2                                                      │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   # 语义上下文                                                          │  │   ║
║  │  │     - semantic_context: "视频在5.0s处发生重大场景变化，                  │  │   ║
║  │  │                          分为2个事件段，可能包含2个不同物体"             │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   # 内存效率                                                            │  │   ║
║  │  │     - memory_saved: 60% (3/5 帧被压缩)                                  │  │   ║
║  │  │     - gpu_memory: 稳定 (不随视频长度增长)                                │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                     ║
╚═════════════════════════════════════════════════════════════════════════════════════╝
                                        │
                                        │
┌───────────────────────────────────────┼─────────────────────────────────────────────┐
│                                       ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                 惊讶度反馈 → 意图更新 (增强版双向循环)                        │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐│    │
│  │  │                                                                         ││    │
│  │  │   V-JEPA2 惊讶度分析 ────────────────────────────▶ 意图状态更新          ││    │
│  │  │                                                                         ││    │
│  │  │   检测到 1 个事件边界    ───▶  确认场景变化，建议关注边界帧               ││    │
│  │  │   2 个事件段            ───▶  可能有 2 个不同物体，强化 COUNT 意图       ││    │
│  │  │   高惊讶度帧 [帧4]       ───▶  标记为"意外内容"，优先送入 Gemma          ││    │
│  │  │   3 帧低惊讶度          ───▶  标记为冗余，按需使用                       ││    │
│  │  │                                                                         ││    │
│  │  │   更新后意图:                                                            ││    │
│  │  │     - primary: COUNT (98%)  ← 置信度提升 (2事件支持计数)                 ││    │
│  │  │     - secondary: [COMPARE (45%)]                                        ││    │
│  │  │     - attention_frames: [帧1, 帧4] ← 高惊讶度优先                        ││    │
│  │  │                                                                         ││    │
│  │  └─────────────────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                             │
│                                       ▼                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │
┌───────────────────────────────────────┼─────────────────────────────────────────────┐
│                                       ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                    智能帧选择 (惊讶度驱动版)                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐│    │
│  │  │                                                                         ││    │
│  │  │   选择策略 (基于 Cambrian-S):                                            ││    │
│  │  │                                                                         ││    │
│  │  │   1. 事件代表帧: 每个事件段选 1 帧 (事件中心或边界帧)                     ││    │
│  │  │   2. 高惊讶度帧: S > threshold 的帧优先                                  ││    │
│  │  │   3. 首尾帧: 视频开始和结束 (上下文锚点)                                  ││    │
│  │  │   4. 按需补充: 如果关键帧不足，从长期记忆解压                             ││    │
│  │  │                                                                         ││    │
│  │  │   选择过程:                                                              ││    │
│  │  │     ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                    ││    │
│  │  │     │帧1   │  │帧2   │  │帧3   │  │帧4   │  │帧5   │                    ││    │
│  │  │     │S=0.00│  │S=0.03│  │S=0.05│  │S=0.32│  │S=0.04│                    ││    │
│  │  │     │事件A │  │(压缩)│  │(压缩)│  │事件B │  │(压缩)│                    ││    │
│  │  │     │首帧  │  │      │  │      │  │边界★│  │      │                    ││    │
│  │  │     └──┬───┘  └──────┘  └──────┘  └──┬───┘  └──────┘                    ││    │
│  │  │        │                             │                                  ││    │
│  │  │        └─────────────┬───────────────┘                                  ││    │
│  │  │                      │                                                  ││    │
│  │  │                      ▼                                                  ││    │
│  │  │            选中: 帧1 (事件A代表), 帧4 (高惊讶度+事件B代表)               ││    │
│  │  │                                                                         ││    │
│  │  │   对比旧方案:                                                            ││    │
│  │  │   ┌─────────────────────────────────────────────────────────────────┐   ││    │
│  │  │   │  旧: 选择 帧1, 帧3, 帧4 (聚类中心 + 变化峰值) → 3 帧              │   ││    │
│  │  │   │  新: 选择 帧1, 帧4 (事件代表 + 高惊讶度)      → 2 帧 (更高效!)   │   ││    │
│  │  │   └─────────────────────────────────────────────────────────────────┘   ││    │
│  │  │                                                                         ││    │
│  │  │   选择理由: "基于惊讶度选择事件代表帧，帧4惊讶度0.32表明重大场景变化"    ││    │
│  │  │                                                                         ││    │
│  │  └─────────────────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                             │
│                                       │  选中的关键帧 + 惊讶度上下文                 │
│                                       ▼                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │
╔═════════════════════════════════════════════════════════════════════════════════════╗
║                             Gemma 3n 处理模块                                        ║
╠═════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                     ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                        1. 构建增强多模态输入                                   │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   输入组成 (惊讶度增强版):                                               │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │  🖼️ 图像序列 (惊讶度排序):                                       │  │  │   ║
║  │  │   │    [帧4: 6.0s, S=0.32★] [帧1: 0.0s, S=0.00]                     │  │  │   ║
║  │  │   │    ↑ 高惊讶度帧优先展示                                          │  │  │   ║
║  │  │   │                                                                  │  │  │   ║
║  │  │   │  📝 V-JEPA2 惊讶度上下文 (新增):                                   │  │  │   ║
║  │  │   │    "视频在5.0s处发生重大变化(惊讶度0.32)，分为2个事件段。          │  │  │   ║
║  │  │   │     帧4显示了预期之外的新内容，请特别注意该帧。"                   │  │  │   ║
║  │  │   │                                                                  │  │  │   ║
║  │  │   │  💬 用户问题:                                                     │  │  │   ║
║  │  │   │    "这里面有几台笔记本电脑？"                                      │  │  │   ║
║  │  │   │                                                                  │  │  │   ║
║  │  │   │  🎯 意图提示:                                                     │  │  │   ║
║  │  │   │    "用户想要计数 (COUNT)，V-JEPA2 检测到 2 个事件段"              │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                       │                                             ║
║                                       ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                       2. Gemma 3n 多模态推理                                  │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │        ┌────────────┐              ┌────────────┐                      │  │   ║
║  │  │        │   帧4 ★   │              │   帧1      │                      │  │   ║
║  │  │        │  (Dell)    │              │  (MacBook) │                      │  │   ║
║  │  │        │  S=0.32    │              │  S=0.00    │                      │  │   ║
║  │  │        └─────┬──────┘              └─────┬──────┘                      │  │   ║
║  │  │              │                           │                             │  │   ║
║  │  │              └─────────────┬─────────────┘                             │  │   ║
║  │  │                            │                                           │  │   ║
║  │  │                            ▼                                           │  │   ║
║  │  │              ╔═══════════════════════════════════╗                     │  │   ║
║  │  │              ║        Gemma 3n E2B/E4B          ║                     │  │   ║
║  │  │              ║    (多模态视觉-语言模型)          ║                     │  │   ║
║  │  │              ║                                  ║                     │  │   ║
║  │  │              ║  Prompt 增强:                    ║                     │  │   ║
║  │  │              ║  "第一张图(帧4)是高惊讶度帧，     ║                     │  │   ║
║  │  │              ║   表示出现了意料之外的内容"      ║                     │  │   ║
║  │  │              ╚═══════════════════════════════════╝                     │  │   ║
║  │  │                            │                                           │  │   ║
║  │  │                            │  视觉理解 + 惊讶度引导                     │  │   ║
║  │  │                            ▼                                           │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                       │                                             ║
║                                       ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                        3. 生成自然语言回答                                    │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   视频中一共出现了 **2** 台笔记本电脑。                            │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   **第一台** (在视频 5 秒后出现，引起了显著的场景变化):            │  │  │   ║
║  │  │   │   - Dell 笔记本电脑                                              │  │  │   ║
║  │  │   │   - 银色外壳，黑色键盘                                           │  │  │   ║
║  │  │   │   - 屏幕显示 Ubuntu 桌面 (粉紫色背景)                             │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   **第二台** (视频开始时就在画面中):                               │  │  │   ║
║  │  │   │   - MacBook Pro 笔记本电脑                                       │  │  │   ║
║  │  │   │   - 银色外壳，黑色键盘                                           │  │  │   ║
║  │  │   │   - 屏幕显示 Google 地图                                         │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                     ║
╚═════════════════════════════════════════════════════════════════════════════════════╝
                                        │
                                        │
┌───────────────────────────────────────┼─────────────────────────────────────────────┐
│                                       ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                            输出层                                            │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐│    │
│  │  │                                                                         ││    │
│  │  │   📢 语音合成输出 (TTS)                                                  ││    │
│  │  │                                                                         ││    │
│  │  │   "视频中一共有2台笔记本电脑。第一台是 Dell 笔记本，运行 Ubuntu；        ││    │
│  │  │    第二台是 MacBook Pro，显示 Google 地图。"                             ││    │
│  │  │                                                                         ││    │
│  │  │   👤 ──▶ 用户                                                            ││    │
│  │  │                                                                         ││    │
│  │  └─────────────────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                          V1 vs V2 方案对比
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────┬─────────────────────────────────────────────────┐
│           V1 (原方案)               │           V2 (Cambrian-S 增强)                  │
├─────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                     │                                                 │
│  变化检测:                          │  惊讶度检测:                                     │
│    帧间差异                          │    预测误差 (更智能)                            │
│    cos(E[t], E[t+1])                │    cos(Ê[t], E[t])                              │
│                                     │                                                 │
│  帧选择:                            │  帧选择:                                         │
│    聚类中心 + 峰值                   │    事件代表 + 高惊讶度                          │
│    选 3 帧                           │    选 2 帧 (更高效)                             │
│                                     │                                                 │
│  内存管理:                          │  内存管理:                                       │
│    全部保留                          │    选择性压缩 (节省 60%)                        │
│                                     │                                                 │
│  长视频处理:                        │  长视频处理:                                     │
│    GPU 内存随长度增长               │    GPU 内存稳定                                  │
│                                     │                                                 │
│  事件理解:                          │  事件理解:                                       │
│    无                               │    自动事件分割                                  │
│                                     │                                                 │
└─────────────────────────────────────┴─────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                          两模型分工总结 (V2)
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────┬─────────────────────────────────────────────────┐
│       V-JEPA2 (时序理解)            │            Gemma 3n (视觉-语言)                 │
├─────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                     │                                                 │
│  🎯 职责:                           │  🎯 职责:                                        │
│    - 视频流编码                      │    - 视觉内容识别                               │
│    - 潜在帧预测 (LFP) ← 新增        │    - 自然语言生成                               │
│    - 惊讶度计算 (VoE) ← 新增        │    - 多图比较推理                               │
│    - 事件分割 ← 新增                │                                                 │
│    - 选择性压缩 ← 新增              │                                                 │
│                                     │                                                 │
│  📥 输入:                            │  📥 输入:                                        │
│    - 视频帧序列                      │    - 惊讶度排序的关键帧                         │
│    - 意图决定的惊讶阈值              │    - 用户问题                                   │
│                                     │    - V-JEPA2 惊讶度上下文                       │
│                                     │                                                 │
│  📤 输出:                            │  📤 输出:                                        │
│    - 惊讶度分数序列                  │    - 自然语言回答                               │
│    - 事件边界                        │                                                 │
│    - 关键帧 (高惊讶度)               │                                                 │
│    - 压缩帧 (低惊讶度)               │                                                 │
│                                     │                                                 │
│  💪 核心能力:                        │  💪 核心能力:                                    │
│    - 预测未来帧                      │    - 精确物体识别                               │
│    - 检测"意外"内容                  │    - 理解惊讶度语境                             │
│    - 高效内存管理                    │    - 自然语言表达                               │
│                                     │                                                 │
│  ⏱️ 处理: ~50ms/帧                  │  ⏱️ 处理: ~2-5s                                 │
│  💾 内存: 稳定 (不随长度增长)        │  💾 内存: 固定                                   │
│                                     │                                                 │
└─────────────────────────────────────┴─────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                          惊讶度驱动的双向循环机制 (V2)
═══════════════════════════════════════════════════════════════════════════════════════


                    ┌─────────────────────────────────────┐
                    │           用户意图                  │
                    │   (COUNT, LOCATE, COMPARE, ...)    │
                    └──────────────┬──────────────────────┘
                                   │
                         ┌─────────┴─────────┐
                         │                   │
                         ▼                   │
              ┌─────────────────────┐        │
              │  V-JEPA2 惊讶阈值   │        │
              │   (由意图决定)      │        │
              │                     │        │
              │  COUNT → 0.10      │        │
              │  LOCATE → 0.15     │        │
              │  COMPARE → 0.25    │        │
              └─────────┬───────────┘        │
                        │                    │
                        ▼                    │
              ┌─────────────────────┐        │
              │   V-JEPA2 处理      │        │
              │  - 流式编码         │        │
              │  - 潜在帧预测 (LFP) │        │
              │  - 惊讶度计算 (VoE) │        │
              │  - 选择性压缩       │        │
              └─────────┬───────────┘        │
                        │                    │
                        ▼                    │
              ┌─────────────────────┐        │
              │   惊讶度分析        │────────┘
              │   反馈到意图        │  (双向循环)
              │                     │
              │  高惊讶度 → 关注    │
              │  低惊讶度 → 压缩    │
              │  事件边界 → COUNT   │
              └─────────┬───────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │  惊讶度驱动帧选择   │
              │  (高惊讶度优先)     │
              └─────────┬───────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │     Gemma 3n       │
              │  (惊讶度上下文)     │
              └─────────┬───────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │     自然语言        │
              │       回答          │
              └─────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                          Cambrian-S 核心思想总结
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│   "人类不会保留每一个视觉细节，而是学习生成过程，用预测误差来定义什么是重要的"       │
│                                                                                     │
│   ─────────────────────────────────────────────────────────────────────────────     │
│                                                                                     │
│   核心机制:                                                                         │
│                                                                                     │
│   1. 潜在帧预测 (Latent Frame Prediction, LFP)                                     │
│      - V-JEPA2 预测下一帧的 embedding                                               │
│      - 不需要额外训练，利用 V-JEPA 的预测能力                                       │
│                                                                                     │
│   2. 违反预期 (Violation-of-Expectation, VoE)                                      │
│      - 惊讶度 = 预测 vs 实际的差异                                                  │
│      - 高惊讶度 = 出现了"意料之外"的内容 = 需要关注                                 │
│                                                                                     │
│   3. 选择性处理 (Selective Processing)                                             │
│      - 高惊讶度帧: 保留完整信息，优先送入 VLM                                       │
│      - 低惊讶度帧: 压缩存储，按需使用                                               │
│                                                                                     │
│   4. 事件分割 (Event Segmentation)                                                  │
│      - 高惊讶度帧自然成为事件边界                                                   │
│      - 将长视频分割为语义连贯的片段                                                 │
│                                                                                     │
│   5. 稳定内存 (Stable Memory)                                                       │
│      - GPU 内存不随视频长度增长                                                     │
│      - 支持处理任意长度的视频流                                                     │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                          实现参考代码
═══════════════════════════════════════════════════════════════════════════════════════

class SurpriseBasedVJEPAProcessor:
    '''
    融合 Cambrian-S 思想的 V-JEPA2 处理器
    '''

    def __init__(self,
                 vjepa_model,
                 surprise_threshold: float = 0.10,
                 compression_ratio: int = 2):
        self.vjepa = vjepa_model
        self.surprise_threshold = surprise_threshold
        self.compression_ratio = compression_ratio

        # 记忆系统
        self.key_frames = []           # 高惊讶度关键帧
        self.long_term_memory = []     # 压缩后的低惊讶度帧
        self.event_boundaries = []     # 事件边界时间点

    def process_frame(self, frame, timestamp: float, prev_embedding=None):
        '''
        处理单帧，返回惊讶度和处理决策
        '''
        # 1. 编码当前帧
        current_embedding = self.vjepa.encode(frame)

        # 2. 计算惊讶度 (VoE)
        if prev_embedding is not None:
            # V-JEPA 预测下一帧
            predicted_embedding = self.vjepa.predict_next(prev_embedding)
            surprise = 1 - cosine_similarity(predicted_embedding, current_embedding)
        else:
            surprise = 1.0  # 首帧

        # 3. 根据惊讶度决策
        if surprise > self.surprise_threshold:
            # 高惊讶度 = 关键帧
            self.key_frames.append({
                'embedding': current_embedding,
                'frame': frame,
                'timestamp': timestamp,
                'surprise': surprise,
            })

            # 超高惊讶度 = 事件边界
            if surprise > 0.25:
                self.event_boundaries.append(timestamp)
        else:
            # 低惊讶度 = 压缩存储
            compressed = self.compress(current_embedding)
            self.long_term_memory.append({
                'embedding': compressed,
                'timestamp': timestamp,
            })

        return current_embedding, surprise

    def get_frames_for_vlm(self, max_frames: int = 4):
        '''
        获取送入 VLM 的帧 (惊讶度排序)
        '''
        # 按惊讶度排序
        sorted_frames = sorted(
            self.key_frames,
            key=lambda x: x['surprise'],
            reverse=True
        )
        return sorted_frames[:max_frames]

    def get_semantic_context(self):
        '''
        生成 V-JEPA2 语义上下文 (供 Gemma 使用)
        '''
        n_events = len(self.event_boundaries) + 1
        max_surprise = max(f['surprise'] for f in self.key_frames)

        return f'''视频分析结果:
- 检测到 {n_events} 个事件段
- 事件边界: {self.event_boundaries}
- 最高惊讶度: {max_surprise:.2f} (表示出现了预期之外的内容)
- 保留 {len(self.key_frames)} 个关键帧
- 压缩 {len(self.long_term_memory)} 个冗余帧
'''

═══════════════════════════════════════════════════════════════════════════════════════
"""
