"""
═══════════════════════════════════════════════════════════════════════════════════════
                    AI 眼镜系统 - V-JEPA2 + Gemma 3n 协作流程图
═══════════════════════════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   用户交互层                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    👤 用户                                                                          │
│      │                                                                              │
│      │  语音/文字查询: "这里面有几台笔记本电脑？"                                      │
│      ▼                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                          意图分析模块                                        │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  输入: 用户查询文本                                                  │    │    │
│  │  │  处理: 关键词匹配 + 语义分析                                          │    │    │
│  │  │  输出:                                                               │    │    │
│  │  │    - 意图类型: COUNT (计数)                                          │    │    │
│  │  │    - 置信度: 95%                                                     │    │    │
│  │  │    - 匹配关键词: ["几", "几台"]                                       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│      │                                                                              │
│      │  意图类型                                                                    │
│      ▼                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │
┌────────────────────────────────────────┼────────────────────────────────────────────┐
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     意图 → V-JEPA2 策略映射                                  │    │
│  ├─────────────────────────────────────────────────────────────────────────────┤    │
│  │                                                                             │    │
│  │   意图类型          │  V-JEPA2 提取策略        │  说明                       │    │
│  │  ─────────────────────────────────────────────────────────────────────────  │    │
│  │   COUNT (计数)      │  FULL_ENCODE_CLUSTER    │  全帧编码 + 聚类分析        │    │
│  │   LOCATE (定位)     │  DENSE_PEAK_DETECT      │  密集编码 + 峰值检测        │    │
│  │   COMPARE (对比)    │  START_END_CHANGE       │  首尾编码 + 变化点检测      │    │
│  │   DESCRIBE (描述)   │  UNIFORM_REPRESENTATIVE │  均匀采样 + 代表性选择      │    │
│  │   TRACK (跟踪)      │  HIGH_FREQ_CONTINUOUS   │  高频编码 + 连续相似度      │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        │  策略: FULL_ENCODE_CLUSTER                 │
│                                        ▼                                            │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │
╔═════════════════════════════════════════════════════════════════════════════════════╗
║                              V-JEPA2 处理模块                                        ║
╠═════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                     ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                         1. 视频帧编码                                         │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   📹 视频流                                                            │  │   ║
║  │  │      │                                                                 │  │   ║
║  │  │      ▼                                                                 │  │   ║
║  │  │   ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐                         │  │   ║
║  │  │   │帧 1 │  │帧 2 │  │帧 3 │  │帧 4 │  │帧 5 │  ...                    │  │   ║
║  │  │   └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘                         │  │   ║
║  │  │      │        │        │        │        │                             │  │   ║
║  │  │      ▼        ▼        ▼        ▼        ▼                             │  │   ║
║  │  │   ╔═════════════════════════════════════════════╗                      │  │   ║
║  │  │   ║           V-JEPA2 编码器                    ║                      │  │   ║
║  │  │   ║         (ViT-L, 1024维)                     ║                      │  │   ║
║  │  │   ╚═════════════════════════════════════════════╝                      │  │   ║
║  │  │      │        │        │        │        │                             │  │   ║
║  │  │      ▼        ▼        ▼        ▼        ▼                             │  │   ║
║  │  │   [E₁]     [E₂]     [E₃]     [E₄]     [E₅]     (1024维 embedding)     │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                        │                                            ║
║                                        ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                       2. 变化分数计算                                         │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   变化分数 = 1 - cosine_similarity(Eᵢ, Eᵢ₊₁)                          │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   [E₁]──→[E₂]──→[E₃]──→[E₄]──→[E₅]                                    │  │   ║
║  │  │       0.02   0.03   0.25   0.02                                        │  │   ║
║  │  │                      ↑                                                 │  │   ║
║  │  │                   峰值检测                                              │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   输出: change_scores = [0.0, 0.02, 0.03, 0.25, 0.02]                  │  │   ║
║  │  │         peak_times = [4.0s]  (帧3→帧4 有显著变化)                       │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                        │                                            ║
║                                        ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                       3. 语义聚类分析 (COUNT 策略)                            │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   使用 K-Means 对 embedding 聚类:                                       │  │   ║
║  │  │                                                                        │  │   ║
║  │  │        聚类 A              聚类 B                                       │  │   ║
║  │  │     ┌─────────┐        ┌─────────┐                                     │  │   ║
║  │  │     │ E₁, E₂  │        │ E₄, E₅  │                                     │  │   ║
║  │  │     │ (MacBook)│        │ (Dell)  │                                     │  │   ║
║  │  │     └─────────┘        └─────────┘                                     │  │   ║
║  │  │          │                  │                                          │  │   ║
║  │  │          ▼                  ▼                                          │  │   ║
║  │  │      中心帧: 帧1        中心帧: 帧4                                      │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   输出: cluster_labels = [0, 0, 0, 1, 1]                               │  │   ║
║  │  │         cluster_centers = [帧1, 帧4]                                    │  │   ║
║  │  │         n_clusters = 2 (提示: 可能有2个不同物体/场景)                    │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                        │                                            ║
║                                        ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                      4. V-JEPA2 分析结果汇总                                  │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │   VJEPAAnalysis:                                                       │  │   ║
║  │  │     - embeddings: [E₁, E₂, E₃, E₄, E₅]                                 │  │   ║
║  │  │     - change_scores: [0.0, 0.02, 0.03, 0.25, 0.02]                     │  │   ║
║  │  │     - peak_times: [4.0s]                                               │  │   ║
║  │  │     - cluster_centers: [帧1, 帧4]                                       │  │   ║
║  │  │     - activity_level: "medium"                                         │  │   ║
║  │  │     - has_significant_change: True                                     │  │   ║
║  │  │     - semantic_context: "视频分为2个场景片段，在4.0s处有显著变化"         │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                     ║
╚═════════════════════════════════════════════════════════════════════════════════════╝
                                         │
                                         │
┌────────────────────────────────────────┼────────────────────────────────────────────┐
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                        意图反馈更新 (双向循环)                               │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐│    │
│  │  │                                                                         ││    │
│  │  │   V-JEPA2 分析 ──────────────────────────────────▶ 意图状态更新          ││    │
│  │  │                                                                         ││    │
│  │  │   发现 2 个聚类        ───▶  确认 COUNT 意图，建议关注聚类中心帧          ││    │
│  │  │   检测到显著变化       ───▶  添加次要意图 COMPARE (40%)                  ││    │
│  │  │   峰值时间 [4.0s]      ───▶  标记关键时间点                              ││    │
│  │  │                                                                         ││    │
│  │  │   更新后意图:                                                            ││    │
│  │  │     - primary: COUNT (95%)                                              ││    │
│  │  │     - secondary: [COMPARE (40%)]                                        ││    │
│  │  │                                                                         ││    │
│  │  └─────────────────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        ▼                                            │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │
┌────────────────────────────────────────┼────────────────────────────────────────────┐
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                           智能帧选择                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐│    │
│  │  │                                                                         ││    │
│  │  │   选择依据:                                                              ││    │
│  │  │     1. 意图类型 (COUNT → 需要看所有可能包含目标物体的帧)                  ││    │
│  │  │     2. 聚类中心帧 (每个聚类选一帧，确保覆盖不同物体)                      ││    │
│  │  │     3. 变化峰值帧 (变化处可能有新物体出现)                                ││    │
│  │  │                                                                         ││    │
│  │  │   选择结果:                                                              ││    │
│  │  │     ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                    ││    │
│  │  │     │帧1   │  │帧2   │  │帧3   │  │帧4 ★│  │帧5   │                    ││    │
│  │  │     │0.0s  │  │2.0s  │  │4.0s  │  │6.0s  │  │8.0s  │                    ││    │
│  │  │     │聚类A │  │      │  │峰值  │  │聚类B │  │      │                    ││    │
│  │  │     └──┬───┘  └──────┘  └──┬───┘  └──┬───┘  └──────┘                    ││    │
│  │  │        │                   │         │                                  ││    │
│  │  │        └───────────────────┼─────────┘                                  ││    │
│  │  │                            │                                            ││    │
│  │  │                            ▼                                            ││    │
│  │  │                   选中: 帧1, 帧3, 帧4 (送入 Gemma)                       ││    │
│  │  │                                                                         ││    │
│  │  │   选择理由: "选择聚类中心帧 + 变化峰值帧"                                 ││    │
│  │  │                                                                         ││    │
│  │  └─────────────────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        │  选中的关键帧 + V-JEPA2 上下文             │
│                                        ▼                                            │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │
╔═════════════════════════════════════════════════════════════════════════════════════╗
║                             Gemma 3n 处理模块                                        ║
╠═════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                     ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                        1. 构建多模态输入                                      │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   输入组成:                                                             │  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │  🖼️ 图像序列:                                                    │  │  │   ║
║  │  │   │    [帧1: 0.0s] [帧3: 4.0s] [帧4: 6.0s]                           │  │  │   ║
║  │  │   │                                                                  │  │  │   ║
║  │  │   │  📝 V-JEPA2 上下文提示:                                           │  │  │   ║
║  │  │   │    "视频分为2个场景片段，在4.0s处有显著变化"                        │  │  │   ║
║  │  │   │                                                                  │  │  │   ║
║  │  │   │  💬 用户问题:                                                     │  │  │   ║
║  │  │   │    "这里面有几台笔记本电脑？"                                      │  │  │   ║
║  │  │   │                                                                  │  │  │   ║
║  │  │   │  🎯 意图提示:                                                     │  │  │   ║
║  │  │   │    "用户想要计数 (COUNT)"                                         │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                        │                                            ║
║                                        ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                       2. Gemma 3n 多模态推理                                  │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │        ┌────────────┐   ┌────────────┐   ┌────────────┐                │  │   ║
║  │  │        │   帧1      │   │   帧3      │   │   帧4      │                │  │   ║
║  │  │        │  (MacBook) │   │  (过渡)    │   │  (Dell)    │                │  │   ║
║  │  │        └─────┬──────┘   └─────┬──────┘   └─────┬──────┘                │  │   ║
║  │  │              │               │               │                         │  │   ║
║  │  │              └───────────────┼───────────────┘                         │  │   ║
║  │  │                              │                                         │  │   ║
║  │  │                              ▼                                         │  │   ║
║  │  │              ╔═══════════════════════════════════╗                     │  │   ║
║  │  │              ║        Gemma 3n E2B/E4B          ║                     │  │   ║
║  │  │              ║    (多模态视觉-语言模型)          ║                     │  │   ║
║  │  │              ╚═══════════════════════════════════╝                     │  │   ║
║  │  │                              │                                         │  │   ║
║  │  │                              │  视觉理解 + 语言生成                     │  │   ║
║  │  │                              ▼                                         │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                        │                                            ║
║                                        ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────┐   ║
║  │                        3. 生成自然语言回答                                    │   ║
║  │  ┌────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                                                                        │  │   ║
║  │  │   ┌─────────────────────────────────────────────────────────────────┐  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   视频中一共出现了 **2** 台笔记本电脑。                            │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   **第一台笔记本电脑**：                                          │  │  │   ║
║  │  │   │   - 位于视频左上角                                               │  │  │   ║
║  │  │   │   - 银色屏幕，显示 Google 搜索                                    │  │  │   ║
║  │  │   │   - 黑色键盘                                                     │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   │   **第二台笔记本电脑**：                                          │  │  │   ║
║  │  │   │   - 位于视频右下角                                               │  │  │   ║
║  │  │   │   - 银色屏幕，显示红黑色界面                                      │  │  │   ║
║  │  │   │   - 黑色键盘                                                     │  │  │   ║
║  │  │   │                                                                 │  │  │   ║
║  │  │   └─────────────────────────────────────────────────────────────────┘  │  │   ║
║  │  │                                                                        │  │   ║
║  │  └────────────────────────────────────────────────────────────────────────┘  │   ║
║  └──────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                     ║
╚═════════════════════════════════════════════════════════════════════════════════════╝
                                         │
                                         │
┌────────────────────────────────────────┼────────────────────────────────────────────┐
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                            输出层                                            │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐│    │
│  │  │                                                                         ││    │
│  │  │   📢 语音合成输出 (TTS)                                                  ││    │
│  │  │                                                                         ││    │
│  │  │   "视频中一共有2台笔记本电脑。第一台是银色的 MacBook，                    ││    │
│  │  │    正在显示 Google 搜索。第二台是银色的 Dell 笔记本，                     ││    │
│  │  │    运行的是 Linux 系统。"                                                ││    │
│  │  │                                                                         ││    │
│  │  │   👤 ──▶ 用户                                                            ││    │
│  │  │                                                                         ││    │
│  │  └─────────────────────────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                                 两模型分工总结
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────┬─────────────────────────────────────────────────┐
│           V-JEPA2                   │                 Gemma 3n                        │
├─────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                     │                                                 │
│  🎯 职责: 视频时序理解               │  🎯 职责: 视觉-语言对齐                         │
│                                     │                                                 │
│  📥 输入:                            │  📥 输入:                                        │
│    - 视频帧序列                      │    - 选中的关键帧图像                           │
│    - 提取策略                        │    - 用户问题                                   │
│                                     │    - V-JEPA2 上下文                             │
│                                     │                                                 │
│  📤 输出:                            │  📤 输出:                                        │
│    - 1024维 embedding               │    - 自然语言回答                               │
│    - 变化分数序列                    │                                                 │
│    - 聚类分析结果                    │                                                 │
│    - 语义上下文                      │                                                 │
│                                     │                                                 │
│  💪 优势:                            │  💪 优势:                                        │
│    - 理解视频动态                    │    - 精确的物体识别                             │
│    - 无需文字就能检测变化            │    - 图文关联理解                               │
│    - 高效的帧选择                    │    - 自然语言生成                               │
│    - 语义聚类能力                    │    - 多图比较能力                               │
│                                     │                                                 │
│  ⏱️ 处理时间: ~50ms/帧              │  ⏱️ 处理时间: ~2-5s                             │
│                                     │                                                 │
└─────────────────────────────────────┴─────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                                双向循环机制
═══════════════════════════════════════════════════════════════════════════════════════

                    ┌─────────────────────────────────────┐
                    │           用户意图                  │
                    │   (COUNT, LOCATE, COMPARE, ...)    │
                    └──────────────┬──────────────────────┘
                                   │
                         ┌─────────┴─────────┐
                         │                   │
                         ▼                   │
              ┌─────────────────────┐        │
              │    V-JEPA2 策略     │        │
              │  (根据意图选择)      │        │
              └─────────┬───────────┘        │
                        │                    │
                        ▼                    │
              ┌─────────────────────┐        │
              │   V-JEPA2 处理      │        │
              │  - 编码             │        │
              │  - 变化检测         │        │
              │  - 聚类分析         │        │
              └─────────┬───────────┘        │
                        │                    │
                        ▼                    │
              ┌─────────────────────┐        │
              │   Embedding 分析    │────────┘
              │   反馈到意图        │  (双向循环)
              │                     │
              │  检测到变化 → COMPARE │
              │  多个聚类 → COUNT    │
              └─────────┬───────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │    智能帧选择       │
              │  (基于意图+分析)    │
              └─────────┬───────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │     Gemma 3n       │
              │   多模态理解        │
              └─────────┬───────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │     自然语言        │
              │       回答          │
              └─────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
"""
