<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API ä¸¥æ ¼å¯¹æ¯”æµ‹è¯•</title>
    <style>
        :root {
            --primary: #4285f4;
            --success: #34a853;
            --warning: #fbbc05;
            --error: #ea4335;
            --bg: #f8f9fa;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
            --left-color: #1a73e8;
            --right-color: #34a853;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Google Sans', 'Roboto', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header h1 {
            font-size: 1.3em;
            color: var(--primary);
        }

        .config-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .config-item label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .config-item input {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
        }

        .config-item input.url { width: 220px; }
        .config-item input.api-key { width: 180px; font-family: monospace; }

        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1a73e8; }
        .btn-success { background: var(--success); color: white; }

        .main-container {
            max-width: 1900px;
            margin: 0 auto;
            padding: 15px;
        }

        .test-selector {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .test-selector h3 {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .test-tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .test-tab {
            padding: 5px 12px;
            border: 1px solid var(--border);
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            background: white;
            transition: all 0.2s;
        }

        .test-tab:hover { background: var(--bg); }
        .test-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ä¸‰æ å¸ƒå±€: å·¦è¾¹çœŸå®API, ä¸­é—´å¯¹æ¯”ç»“æœ, å³è¾¹æœ¬åœ°æœåŠ¡ */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 400px 1fr;
            gap: 15px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel.left .panel-header {
            background: linear-gradient(135deg, #e8f0fe, #f8f9fa);
            border-left: 3px solid var(--left-color);
        }

        .panel.right .panel-header {
            background: linear-gradient(135deg, #e6f4ea, #f8f9fa);
            border-left: 3px solid var(--right-color);
        }

        .panel.center .panel-header {
            background: linear-gradient(135deg, #fff3e0, #f8f9fa);
            border-left: 3px solid var(--warning);
        }

        .panel-title {
            font-weight: 600;
            font-size: 13px;
        }

        .panel.left .panel-title { color: var(--left-color); }
        .panel.right .panel-title { color: var(--right-color); }
        .panel.center .panel-title { color: #e65100; }

        .panel-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-pending { background: var(--border); color: var(--text-secondary); }
        .badge-running { background: var(--warning); color: #000; }
        .badge-success { background: var(--success); color: white; }
        .badge-error { background: var(--error); color: white; }

        .panel-content {
            padding: 12px;
            max-height: 700px;
            overflow-y: auto;
        }

        .code-block {
            background: var(--code-bg);
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .code-block pre {
            color: var(--code-text);
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
        }

        /* å¯¹æ¯”ç»“æœæ ·å¼ */
        .compare-section {
            margin-bottom: 15px;
        }

        .compare-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .compare-item {
            display: flex;
            align-items: flex-start;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        .compare-item.match {
            background: #e6f4ea;
            border-left: 3px solid var(--success);
        }

        .compare-item.mismatch {
            background: #fce8e6;
            border-left: 3px solid var(--error);
        }

        .compare-item.missing-left {
            background: #fff3e0;
            border-left: 3px solid var(--warning);
        }

        .compare-item.missing-right {
            background: #fce8e6;
            border-left: 3px solid var(--error);
        }

        .compare-item.order-diff {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .compare-icon {
            width: 18px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .compare-path {
            color: var(--text);
            flex: 1;
            word-break: break-all;
        }

        .compare-detail {
            color: var(--text-secondary);
            font-size: 11px;
            margin-left: 26px;
            margin-top: 2px;
        }

        /* ç»Ÿè®¡æ‘˜è¦ */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: var(--bg);
        }

        .stat-box.success { background: #e6f4ea; }
        .stat-box.error { background: #fce8e6; }
        .stat-box.warning { background: #fff3e0; }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .stat-box.success .stat-value { color: var(--success); }
        .stat-box.error .stat-value { color: var(--error); }
        .stat-box.warning .stat-value { color: #e65100; }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* è¯·æ±‚é¢„è§ˆ */
        .request-preview {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .request-preview h3 {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .request-preview .code-block {
            max-height: 150px;
        }

        @media (max-width: 1400px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
            .panel.center {
                order: -1;
            }
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 11px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-dot.match { background: var(--success); }
        .legend-dot.mismatch { background: var(--error); }
        .legend-dot.missing { background: var(--warning); }
        .legend-dot.order { background: #9c27b0; }

        /* éŸ³é¢‘æµ‹è¯•ä¸“åŒº */
        .audio-test-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border-left: 4px solid #ff5722;
        }

        .audio-test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .audio-test-header h3 {
            font-size: 14px;
            color: #ff5722;
            margin: 0;
        }

        .audio-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .audio-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .audio-status.recording {
            color: var(--error);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .audio-preview {
            background: var(--bg);
            border-radius: 6px;
            padding: 12px;
        }

        .audio-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 8px 0;
        }

        .audio-prompt {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 10px 0;
        }

        .audio-prompt label {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .audio-prompt input {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
        }

        /* æµ‹è¯•å†å² */
        .test-history {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-header h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .history-item:hover {
            background: var(--bg);
        }

        .history-item.pass {
            border-left: 3px solid var(--success);
        }

        .history-item.fail {
            border-left: 3px solid var(--error);
        }

        .history-time {
            color: var(--text-secondary);
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-bar-fill.indeterminate {
            width: 30%;
            animation: progress-indeterminate 1.5s infinite linear;
        }

        @keyframes progress-indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
    </style>
</head>
<body>
    <!-- å¤–éƒ¨éŸ³é¢‘æ•°æ®æ–‡ä»¶ (MLK Speech, 511KB base64) -->
    <script src="02-gemini-api-audio.js"></script>

    <div class="header">
        <div class="header-content">
            <h1>Gemini API ä¸¥æ ¼å¯¹æ¯”æµ‹è¯•</h1>
            <div class="config-group">
                <div class="config-item">
                    <label>çœŸå® API:</label>
                    <input type="text" id="realApiUrl" class="url" value="https://api.vectorengine.ai">
                </div>
                <div class="config-item">
                    <label>API Key:</label>
                    <input type="password" id="apiKey" class="api-key" value="sk-jSjH0gc2EZNkKSJdBUcVgZN0RXdiOWzzAhWvS4X2goJakiNK">
                </div>
                <div class="config-item">
                    <label>æœ¬åœ°æœåŠ¡:</label>
                    <input type="text" id="localUrl" class="url" value="http://localhost:5001">
                </div>
                <button class="btn btn-primary" onclick="runComparison()">å¯¹æ¯”æµ‹è¯•</button>
                <button class="btn btn-success" onclick="runAllComparisons()">å…¨éƒ¨æµ‹è¯•</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- æµ‹è¯•é€‰æ‹©å™¨ -->
        <div class="test-selector">
            <h3>é€‰æ‹©æµ‹è¯•ç”¨ä¾‹</h3>
            <div class="test-tabs">
                <div class="test-tab active" data-test="1-1">1.1 çº¯æ–‡æœ¬</div>
                <div class="test-tab" data-test="1-2">1.2 æ€è€ƒlow</div>
                <div class="test-tab" data-test="1-3">1.3 æ€è€ƒhigh</div>
                <div class="test-tab" data-test="1-5">1.5 ç³»ç»ŸæŒ‡ä»¤</div>
                <div class="test-tab" data-test="1-6">1.6 JSON Schema</div>
                <div class="test-tab" data-test="3-1">3.1 å·¥å…·è°ƒç”¨</div>
                <div class="test-tab" data-test="4-1">4.1 mode:ANY</div>
                <div class="test-tab" data-test="4-2">4.2 mode:NONE</div>
                <div class="test-tab" data-test="4-3">4.3 å¹¶è¡Œè°ƒç”¨</div>
                <div class="test-tab" data-test="5-1">5.1 å¤šæ¨¡æ€è§†è§‰</div>
                <div class="test-tab" data-test="5-2">5.2 éŸ³é¢‘è½¬å½•</div>
                <div class="test-tab" data-test="5-3">5.3 éŸ³é¢‘+æ€è€ƒ</div>
                <div class="test-tab" data-test="5-4">5.4 éŸ³é¢‘æ‘˜è¦</div>
                <div class="test-tab" data-test="5-5">5.5 å¤šå›¾ç‰‡</div>
                <div class="test-tab" data-test="6-1">6.1 æµå¼è¾“å‡º</div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot match"></div> å®Œå…¨åŒ¹é…</div>
                <div class="legend-item"><div class="legend-dot mismatch"></div> å€¼ä¸åŒ¹é…</div>
                <div class="legend-item"><div class="legend-dot missing"></div> å­—æ®µç¼ºå¤±</div>
                <div class="legend-item"><div class="legend-dot order"></div> é¡ºåºä¸åŒ</div>
            </div>
        </div>

        <!-- è¯·æ±‚é¢„è§ˆ -->
        <div class="request-preview">
            <h3>è¯·æ±‚å†…å®¹ (Request Body)</h3>
            <div class="code-block">
                <pre id="requestPreview">é€‰æ‹©æµ‹è¯•ç”¨ä¾‹æŸ¥çœ‹è¯·æ±‚å†…å®¹...</pre>
            </div>
        </div>

        <!-- éŸ³é¢‘æµ‹è¯•ä¸“åŒº -->
        <div class="audio-test-section" id="audioTestSection" style="display: none;">
            <div class="audio-test-header">
                <h3>ğŸ¤ è‡ªå®šä¹‰éŸ³é¢‘æµ‹è¯•</h3>
                <div class="audio-controls">
                    <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('audioFileInput').click()">
                        ğŸ“ ä¸Šä¼ éŸ³é¢‘
                    </button>
                    <button class="btn" id="recordBtn" onclick="toggleRecording()">
                        ğŸ”´ å½•éŸ³
                    </button>
                    <span id="audioStatus" class="audio-status"></span>
                </div>
            </div>
            <div class="audio-preview" id="audioPreview" style="display: none;">
                <audio id="audioPlayer" controls style="width: 100%;"></audio>
                <div class="audio-info" id="audioInfo"></div>
                <div class="audio-prompt">
                    <label>è‡ªå®šä¹‰æç¤ºè¯:</label>
                    <input type="text" id="customAudioPrompt" value="Transcribe this audio and describe what you hear." style="flex: 1;">
                </div>
                <button class="btn btn-success" onclick="runCustomAudioTest()">ğŸš€ è¿è¡Œè‡ªå®šä¹‰éŸ³é¢‘æµ‹è¯•</button>
            </div>
        </div>

        <!-- æµ‹è¯•å†å²è®°å½• -->
        <div class="test-history" id="testHistory" style="display: none;">
            <div class="history-header">
                <h3>ğŸ“Š æµ‹è¯•å†å²</h3>
                <button class="btn" onclick="clearHistory()">æ¸…ç©º</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- ä¸‰æ å¯¹æ¯” -->
        <div class="comparison-container">
            <!-- å·¦è¾¹ï¼šçœŸå® Gemini API -->
            <div class="panel left">
                <div class="panel-header">
                    <span class="panel-title">çœŸå® Gemini API</span>
                    <span class="panel-badge badge-pending" id="badge-left">å¾…æµ‹è¯•</span>
                </div>
                <div class="panel-content">
                    <div class="code-block" id="response-left">
                        <pre>ç‚¹å‡»"å¯¹æ¯”æµ‹è¯•"æ‰§è¡Œ...</pre>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šå¯¹æ¯”ç»“æœ -->
            <div class="panel center">
                <div class="panel-header">
                    <span class="panel-title">JSON å­—æ®µé€é¡¹å¯¹æ¯”</span>
                    <span class="panel-badge badge-pending" id="badge-center">å¾…å¯¹æ¯”</span>
                </div>
                <div class="panel-content" id="compare-results">
                    <div class="stats-summary" id="stats-summary" style="display: none;">
                        <div class="stat-box success">
                            <div class="stat-value" id="stat-match">0</div>
                            <div class="stat-label">åŒ¹é…</div>
                        </div>
                        <div class="stat-box error">
                            <div class="stat-value" id="stat-mismatch">0</div>
                            <div class="stat-label">ä¸åŒ¹é…</div>
                        </div>
                        <div class="stat-box warning">
                            <div class="stat-value" id="stat-missing-left">0</div>
                            <div class="stat-label">çœŸå®APIç¼ºå¤±</div>
                        </div>
                        <div class="stat-box warning">
                            <div class="stat-value" id="stat-missing-right">0</div>
                            <div class="stat-label">æœ¬åœ°ç¼ºå¤±</div>
                        </div>
                        <div class="stat-box" style="background: #f3e5f5;">
                            <div class="stat-value" id="stat-order" style="color: #9c27b0;">0</div>
                            <div class="stat-label">é¡ºåºä¸åŒ</div>
                        </div>
                    </div>
                    <div id="compare-details">
                        <p style="color: var(--text-secondary); font-size: 12px;">è¿è¡Œæµ‹è¯•åæ˜¾ç¤ºé€é¡¹å¯¹æ¯”ç»“æœ...</p>
                    </div>
                </div>
            </div>

            <!-- å³è¾¹ï¼šæœ¬åœ°æœåŠ¡å™¨ -->
            <div class="panel right">
                <div class="panel-header">
                    <span class="panel-title">æœ¬åœ° Gemma 3n</span>
                    <span class="panel-badge badge-pending" id="badge-right">å¾…æµ‹è¯•</span>
                </div>
                <div class="panel-content">
                    <div class="code-block" id="response-right">
                        <pre>ç‚¹å‡»"å¯¹æ¯”æµ‹è¯•"æ‰§è¡Œ...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTest = '1-1';

        const testConfigs = {
            '1-1': {
                name: '1.1 çº¯æ–‡æœ¬',
                body: {"contents": [{"parts": [{"text": "hi"}]}], "generationConfig": {"maxOutputTokens": 512}}
            },
            '1-2': {
                name: '1.2 æ€è€ƒç­‰çº§ low',
                body: {
                    "contents": [{"parts": [{"text": "2+2=?"}]}],
                    "generationConfig": {"thinkingConfig": {"thinkingLevel": "low"}, "maxOutputTokens": 256}
                }
            },
            '1-3': {
                name: '1.3 æ€è€ƒç­‰çº§ high',
                body: {
                    "contents": [{"parts": [{"text": "Explain quantum entanglement briefly"}]}],
                    "generationConfig": {"thinkingConfig": {"thinkingLevel": "high"}, "maxOutputTokens": 512}
                }
            },
            '1-5': {
                name: '1.5 ç³»ç»ŸæŒ‡ä»¤',
                body: {
                    "contents": [{"parts": [{"text": "hi"}]}],
                    "systemInstruction": {"parts": [{"text": "You are helpful"}]},
                    "generationConfig": {"maxOutputTokens": 512}
                }
            },
            '1-6': {
                name: '1.6 JSON Schema',
                body: {
                    "contents": [{"parts": [{"text": "List 2 programming languages"}]}],
                    "generationConfig": {
                        "responseMimeType": "application/json",
                        "responseSchema": {
                            "type": "object",
                            "properties": {
                                "languages": {
                                    "type": "array",
                                    "items": {"type": "object", "properties": {"name": {"type": "string"}, "year": {"type": "integer"}}}
                                }
                            }
                        },
                        "maxOutputTokens": 512
                    }
                }
            },
            '3-1': {
                name: '3.1 å·¥å…·è°ƒç”¨',
                body: {
                    "contents": [{"role": "user", "parts": [{"text": "Run ls command"}]}],
                    "tools": [{
                        "functionDeclarations": [{
                            "name": "shell_command",
                            "description": "Run shell command",
                            "parameters": {"type": "object", "properties": {"command": {"type": "string"}}, "required": ["command"]}
                        }]
                    }],
                    "generationConfig": {"maxOutputTokens": 512}
                }
            },
            '4-1': {
                name: '4.1 toolConfig mode:ANY',
                body: {
                    "contents": [{"role": "user", "parts": [{"text": "What is the weather?"}]}],
                    "tools": [{"functionDeclarations": [{"name": "get_weather", "description": "Get weather", "parameters": {"type": "object", "properties": {"location": {"type": "string"}}, "required": ["location"]}}]}],
                    "toolConfig": {"functionCallingConfig": {"mode": "ANY"}},
                    "generationConfig": {"maxOutputTokens": 256}
                }
            },
            '4-2': {
                name: '4.2 toolConfig mode:NONE',
                body: {
                    "contents": [{"role": "user", "parts": [{"text": "What is the weather in Tokyo?"}]}],
                    "tools": [{"functionDeclarations": [{"name": "get_weather", "description": "Get weather", "parameters": {"type": "object", "properties": {"location": {"type": "string"}}, "required": ["location"]}}]}],
                    "toolConfig": {"functionCallingConfig": {"mode": "NONE"}},
                    "generationConfig": {"maxOutputTokens": 256}
                }
            },
            '4-3': {
                name: '4.3 å¹¶è¡Œè°ƒç”¨',
                body: {
                    "contents": [{"role": "user", "parts": [{"text": "What is the weather in SF and Tokyo?"}]}],
                    "tools": [{"functionDeclarations": [{"name": "get_weather", "description": "Get weather", "parameters": {"type": "object", "properties": {"location": {"type": "string"}}, "required": ["location"]}}]}],
                    "generationConfig": {"maxOutputTokens": 512}
                }
            },
            '5-1': {
                name: '5.1 å¤šæ¨¡æ€è§†è§‰',
                body: {
                    "contents": [{"role": "user", "parts": [
                        {"text": "What color is this image? Answer in one word."},
                        {"inlineData": {"mimeType": "image/png", "data": "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAANUlEQVR4nO3QsQ0AMAzDsLT//9yeoCkbeYAN6LzZdZf3x0GSKEmUJEoSJYmSREmiJFGSaMoHo8QBPwYSAhsAAAAASUVORK5CYII="}}
                    ]}],
                    "generationConfig": {"maxOutputTokens": 256}
                }
            },
            '5-2': {
                name: '5.2 éŸ³é¢‘è½¬å½•',
                body: {
                    "contents": [{"role": "user", "parts": [
                        {"text": "Listen to this audio clip and transcribe what you hear. What is the speaker saying?"},
                        {"inlineData": {"mimeType": "audio/flac", "data": "AUDIO_PLACEHOLDER"}}
                    ]}],
                    "generationConfig": {"maxOutputTokens": 1024}
                }
            },
            '5-3': {
                name: '5.3 éŸ³é¢‘+æ€è€ƒ',
                body: {
                    "contents": [{"role": "user", "parts": [
                        {"text": "Listen carefully. First transcribe word-by-word, then analyze the rhetorical style and emotional tone."},
                        {"inlineData": {"mimeType": "audio/flac", "data": "AUDIO_PLACEHOLDER"}}
                    ]}],
                    "generationConfig": {
                        "thinkingConfig": {"thinkingLevel": "high"},
                        "maxOutputTokens": 2048
                    }
                }
            },
            '5-4': {
                name: '5.4 éŸ³é¢‘æ‘˜è¦',
                body: {
                    "contents": [{"role": "user", "parts": [
                        {"text": "Summarize this speech in one sentence. What is the main message?"},
                        {"inlineData": {"mimeType": "audio/flac", "data": "AUDIO_PLACEHOLDER"}}
                    ]}],
                    "generationConfig": {"maxOutputTokens": 256}
                }
            },
            '5-5': {
                name: '5.5 å¤šå›¾ç‰‡å¯¹æ¯”',
                body: {
                    "contents": [{"role": "user", "parts": [
                        {"text": "Compare these two images. What colors do you see in each? Answer briefly."},
                        {"inlineData": {"mimeType": "image/png", "data": "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAANUlEQVR4nO3QsQ0AMAzDsLT//9yeoCkbeYAN6LzZdZf3x0GSKEmUJEoSJYmSREmiJFGSaMoHo8QBPwYSAhsAAAAASUVORK5CYII="}},
                        {"inlineData": {"mimeType": "image/png", "data": "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAM0lEQVR4nO3OsQ0AIAwDwez/aaMoKBhgAImChq9O8tNd3x8HSaIkUZIoSZQkShIliab8AC4FAT9cTiF5AAAAAElFTkSuQmCC"}}
                    ]}],
                    "generationConfig": {"maxOutputTokens": 256}
                }
            },
            '6-1': {
                name: '6.1 æµå¼è¾“å‡º',
                body: {
                    "contents": [{"parts": [{"text": "Count from 1 to 5."}]}],
                    "generationConfig": {"maxOutputTokens": 128}
                },
                streaming: true  // æ ‡è®°ä¸ºæµå¼æµ‹è¯•
            }
        };

        // è¿è¡Œæ—¶æ³¨å…¥ MLK éŸ³é¢‘æ•°æ® (ä»å¤–éƒ¨ JS æ–‡ä»¶åŠ è½½)
        if (typeof MLK_SPEECH_AUDIO !== 'undefined') {
            testConfigs['5-2'].body.contents[0].parts[1].inlineData.data = MLK_SPEECH_AUDIO;
            testConfigs['5-3'].body.contents[0].parts[1].inlineData.data = MLK_SPEECH_AUDIO;
            testConfigs['5-4'].body.contents[0].parts[1].inlineData.data = MLK_SPEECH_AUDIO;
        }

        // åˆå§‹åŒ–
        document.querySelectorAll('.test-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.test-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTest = tab.dataset.test;
                updateRequestPreview();
            });
        });

        function updateRequestPreview() {
            const config = testConfigs[currentTest];
            document.getElementById('requestPreview').textContent = JSON.stringify(config.body, null, 2);
        }

        function updateBadge(id, status) {
            const badge = document.getElementById(id);
            badge.className = `panel-badge badge-${status}`;
            badge.textContent = {pending: 'å¾…æµ‹è¯•', running: 'è¿è¡Œä¸­...', success: 'æˆåŠŸ', error: 'å¤±è´¥', comparing: 'å¯¹æ¯”ä¸­...'}[status];
        }

        // ========== æ ¸å¿ƒï¼šä¸¥æ ¼ JSON å¯¹æ¯” ==========

        /**
         * æ·±åº¦å¯¹æ¯”ä¸¤ä¸ª JSON å¯¹è±¡ï¼Œè¿”å›æ‰€æœ‰å·®å¼‚
         */
        function deepCompare(left, right, path = '') {
            const results = [];

            // è·å–é”®é¡ºåºï¼ˆä¿æŒåŸå§‹é¡ºåºï¼‰
            const leftKeys = left ? Object.keys(left) : [];
            const rightKeys = right ? Object.keys(right) : [];
            const allKeys = [...new Set([...leftKeys, ...rightKeys])];

            // æ£€æŸ¥é”®é¡ºåºæ˜¯å¦ç›¸åŒ
            if (leftKeys.length > 0 && rightKeys.length > 0) {
                const leftOrder = leftKeys.filter(k => rightKeys.includes(k)).join(',');
                const rightOrder = rightKeys.filter(k => leftKeys.includes(k)).join(',');
                if (leftOrder !== rightOrder && leftOrder.length > 0) {
                    results.push({
                        type: 'order',
                        path: path || '(root)',
                        leftOrder: leftKeys,
                        rightOrder: rightKeys
                    });
                }
            }

            for (const key of allKeys) {
                const currentPath = path ? `${path}.${key}` : key;
                const leftVal = left ? left[key] : undefined;
                const rightVal = right ? right[key] : undefined;

                // å·¦è¾¹ç¼ºå¤±
                if (leftVal === undefined && rightVal !== undefined) {
                    results.push({
                        type: 'missing-left',
                        path: currentPath,
                        rightVal: summarizeValue(rightVal)
                    });
                    continue;
                }

                // å³è¾¹ç¼ºå¤±
                if (leftVal !== undefined && rightVal === undefined) {
                    results.push({
                        type: 'missing-right',
                        path: currentPath,
                        leftVal: summarizeValue(leftVal)
                    });
                    continue;
                }

                // ç±»å‹ä¸åŒ
                const leftType = getType(leftVal);
                const rightType = getType(rightVal);
                if (leftType !== rightType) {
                    results.push({
                        type: 'mismatch',
                        path: currentPath,
                        leftVal: `(${leftType}) ${summarizeValue(leftVal)}`,
                        rightVal: `(${rightType}) ${summarizeValue(rightVal)}`
                    });
                    continue;
                }

                // é€’å½’å¯¹æ¯”å¯¹è±¡
                if (leftType === 'object') {
                    results.push(...deepCompare(leftVal, rightVal, currentPath));
                    continue;
                }

                // é€’å½’å¯¹æ¯”æ•°ç»„
                if (leftType === 'array') {
                    // å…ˆå¯¹æ¯”æ•°ç»„é•¿åº¦
                    if (leftVal.length !== rightVal.length) {
                        results.push({
                            type: 'mismatch',
                            path: currentPath + '.length',
                            leftVal: leftVal.length,
                            rightVal: rightVal.length
                        });
                    }
                    // å¯¹æ¯”æ¯ä¸ªå…ƒç´ 
                    const maxLen = Math.max(leftVal.length, rightVal.length);
                    for (let i = 0; i < maxLen; i++) {
                        if (i >= leftVal.length) {
                            results.push({
                                type: 'missing-left',
                                path: `${currentPath}[${i}]`,
                                rightVal: summarizeValue(rightVal[i])
                            });
                        } else if (i >= rightVal.length) {
                            results.push({
                                type: 'missing-right',
                                path: `${currentPath}[${i}]`,
                                leftVal: summarizeValue(leftVal[i])
                            });
                        } else if (getType(leftVal[i]) === 'object') {
                            results.push(...deepCompare(leftVal[i], rightVal[i], `${currentPath}[${i}]`));
                        } else if (JSON.stringify(leftVal[i]) !== JSON.stringify(rightVal[i])) {
                            results.push({
                                type: 'mismatch',
                                path: `${currentPath}[${i}]`,
                                leftVal: summarizeValue(leftVal[i]),
                                rightVal: summarizeValue(rightVal[i])
                            });
                        } else {
                            results.push({
                                type: 'match',
                                path: `${currentPath}[${i}]`,
                                value: summarizeValue(leftVal[i])
                            });
                        }
                    }
                    continue;
                }

                // å¯¹æ¯”åŸå§‹å€¼ (å¿½ç•¥ä¸€äº›åŠ¨æ€å­—æ®µ)
                if (shouldIgnoreField(currentPath)) {
                    results.push({
                        type: 'match',
                        path: currentPath,
                        value: '(dynamic, ignored)'
                    });
                    continue;
                }

                if (JSON.stringify(leftVal) === JSON.stringify(rightVal)) {
                    results.push({
                        type: 'match',
                        path: currentPath,
                        value: summarizeValue(leftVal)
                    });
                } else {
                    results.push({
                        type: 'mismatch',
                        path: currentPath,
                        leftVal: summarizeValue(leftVal),
                        rightVal: summarizeValue(rightVal)
                    });
                }
            }

            return results;
        }

        function getType(val) {
            if (val === null) return 'null';
            if (Array.isArray(val)) return 'array';
            return typeof val;
        }

        function summarizeValue(val) {
            if (val === null) return 'null';
            if (val === undefined) return 'undefined';
            if (typeof val === 'string') {
                if (val.length > 50) return `"${val.substring(0, 50)}..."`;
                return `"${val}"`;
            }
            if (typeof val === 'object') {
                const str = JSON.stringify(val);
                if (str.length > 60) return str.substring(0, 60) + '...';
                return str;
            }
            return String(val);
        }

        // å¿½ç•¥åŠ¨æ€å­—æ®µ (æ¯æ¬¡è¯·æ±‚éƒ½ä¼šå˜åŒ–çš„å­—æ®µ)
        function shouldIgnoreField(path) {
            const ignorePaths = [
                'responseId',
                'modelVersion',
                /\.thoughtSignature$/,
                /\.text$/,  // æ–‡æœ¬å†…å®¹æ¯æ¬¡ä¸åŒ
                /usageMetadata\./,  // token è®¡æ•°æ¯æ¬¡ä¸åŒ
            ];
            return ignorePaths.some(p => {
                if (typeof p === 'string') return path === p;
                return p.test(path);
            });
        }

        // æ¸²æŸ“å¯¹æ¯”ç»“æœ
        function renderCompareResults(results) {
            const container = document.getElementById('compare-details');
            const statsContainer = document.getElementById('stats-summary');

            // ç»Ÿè®¡
            const stats = {
                match: results.filter(r => r.type === 'match').length,
                mismatch: results.filter(r => r.type === 'mismatch').length,
                missingLeft: results.filter(r => r.type === 'missing-left').length,
                missingRight: results.filter(r => r.type === 'missing-right').length,
                order: results.filter(r => r.type === 'order').length
            };

            document.getElementById('stat-match').textContent = stats.match;
            document.getElementById('stat-mismatch').textContent = stats.mismatch;
            document.getElementById('stat-missing-left').textContent = stats.missingLeft;
            document.getElementById('stat-missing-right').textContent = stats.missingRight;
            document.getElementById('stat-order').textContent = stats.order;
            statsContainer.style.display = 'grid';

            // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º
            let html = '';

            // é¡ºåºé—®é¢˜
            const orderIssues = results.filter(r => r.type === 'order');
            if (orderIssues.length > 0) {
                html += `<div class="compare-section">
                    <div class="compare-section-title">é”®é¡ºåºå·®å¼‚ (${orderIssues.length})</div>`;
                orderIssues.forEach(r => {
                    html += `<div class="compare-item order-diff">
                        <span class="compare-icon">âš¡</span>
                        <div>
                            <div class="compare-path">${r.path}</div>
                            <div class="compare-detail">çœŸå®: [${r.leftOrder.join(', ')}]</div>
                            <div class="compare-detail">æœ¬åœ°: [${r.rightOrder.join(', ')}]</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // å€¼ä¸åŒ¹é…
            const mismatches = results.filter(r => r.type === 'mismatch');
            if (mismatches.length > 0) {
                html += `<div class="compare-section">
                    <div class="compare-section-title">å€¼ä¸åŒ¹é… (${mismatches.length})</div>`;
                mismatches.forEach(r => {
                    html += `<div class="compare-item mismatch">
                        <span class="compare-icon">âœ—</span>
                        <div>
                            <div class="compare-path">${r.path}</div>
                            <div class="compare-detail">çœŸå®: ${r.leftVal}</div>
                            <div class="compare-detail">æœ¬åœ°: ${r.rightVal}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // æœ¬åœ°ç¼ºå¤±
            const missingRight = results.filter(r => r.type === 'missing-right');
            if (missingRight.length > 0) {
                html += `<div class="compare-section">
                    <div class="compare-section-title">æœ¬åœ°å®ç°ç¼ºå¤± (${missingRight.length})</div>`;
                missingRight.forEach(r => {
                    html += `<div class="compare-item missing-right">
                        <span class="compare-icon">âš </span>
                        <div>
                            <div class="compare-path">${r.path}</div>
                            <div class="compare-detail">çœŸå®APIæœ‰: ${r.leftVal}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // çœŸå®APIç¼ºå¤± (å¯èƒ½æ˜¯æˆ‘ä»¬å¤šåŠ çš„å­—æ®µ)
            const missingLeft = results.filter(r => r.type === 'missing-left');
            if (missingLeft.length > 0) {
                html += `<div class="compare-section">
                    <div class="compare-section-title">çœŸå®APIç¼ºå¤± / æœ¬åœ°å¤šä½™ (${missingLeft.length})</div>`;
                missingLeft.forEach(r => {
                    html += `<div class="compare-item missing-left">
                        <span class="compare-icon">â•</span>
                        <div>
                            <div class="compare-path">${r.path}</div>
                            <div class="compare-detail">æœ¬åœ°æœ‰: ${r.rightVal}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // åŒ¹é…é¡¹ (æŠ˜å æ˜¾ç¤º)
            const matches = results.filter(r => r.type === 'match');
            if (matches.length > 0) {
                html += `<div class="compare-section">
                    <div class="compare-section-title" style="cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        âœ“ åŒ¹é…é¡¹ (${matches.length}) - ç‚¹å‡»å±•å¼€/æŠ˜å 
                    </div>
                    <div style="display: none;">`;
                matches.forEach(r => {
                    html += `<div class="compare-item match">
                        <span class="compare-icon">âœ“</span>
                        <span class="compare-path">${r.path}: ${r.value}</span>
                    </div>`;
                });
                html += '</div></div>';
            }

            container.innerHTML = html || '<p style="color: var(--text-secondary);">æ— å¯¹æ¯”æ•°æ®</p>';

            // æ›´æ–°ä¸­é—´é¢æ¿çŠ¶æ€
            const hasIssues = stats.mismatch + stats.missingRight + stats.order > 0;
            updateBadge('badge-center', hasIssues ? 'error' : 'success');
        }

        async function runComparison() {
            const config = testConfigs[currentTest];
            const realApiUrl = document.getElementById('realApiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const localUrl = document.getElementById('localUrl').value;

            // æ£€æŸ¥æ˜¯å¦æ˜¯æµå¼æµ‹è¯•
            if (config.streaming) {
                return runStreamingComparison(config, realApiUrl, apiKey, localUrl);
            }

            // é‡ç½®çŠ¶æ€
            updateBadge('badge-left', 'running');
            updateBadge('badge-right', 'running');
            updateBadge('badge-center', 'comparing');
            document.getElementById('response-left').innerHTML = '<pre>è¯·æ±‚ä¸­...</pre>';
            document.getElementById('response-right').innerHTML = '<pre>è¯·æ±‚ä¸­...</pre>';
            document.getElementById('compare-details').innerHTML = '<p style="color: var(--text-secondary);">ç­‰å¾…å“åº”...</p>';
            document.getElementById('stats-summary').style.display = 'none';

            let leftResp = null, rightResp = null;

            // å¹¶è¡Œè¯·æ±‚
            const leftPromise = (async () => {
                if (!apiKey) return { error: 'è¯·è¾“å…¥ API Key' };
                try {
                    const resp = await fetch(`${realApiUrl}/v1beta/models/gemini-3-pro-preview:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.body)
                    });
                    return await resp.json();
                } catch (e) {
                    return { error: e.message };
                }
            })();

            const rightPromise = (async () => {
                try {
                    const resp = await fetch(`${localUrl}/v1beta/models/gemini-3-pro-preview:generateContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.body)
                    });
                    return await resp.json();
                } catch (e) {
                    return { error: e.message };
                }
            })();

            [leftResp, rightResp] = await Promise.all([leftPromise, rightPromise]);

            // æ˜¾ç¤ºå·¦è¾¹ç»“æœ
            if (leftResp.error) {
                updateBadge('badge-left', 'error');
                document.getElementById('response-left').innerHTML = `<pre style="color: #f44336;">é”™è¯¯: ${leftResp.error}</pre>`;
            } else {
                updateBadge('badge-left', 'success');
                document.getElementById('response-left').innerHTML = `<pre>${JSON.stringify(leftResp, null, 2)}</pre>`;
            }

            // æ˜¾ç¤ºå³è¾¹ç»“æœ
            if (rightResp.error) {
                updateBadge('badge-right', 'error');
                document.getElementById('response-right').innerHTML = `<pre style="color: #f44336;">é”™è¯¯: ${rightResp.error}\n\nè¯·ç¡®ä¿æœåŠ¡å™¨è¿è¡Œ:\npython apps/gemini_api/server.py</pre>`;
            } else {
                updateBadge('badge-right', 'success');
                document.getElementById('response-right').innerHTML = `<pre>${JSON.stringify(rightResp, null, 2)}</pre>`;
            }

            // æ‰§è¡Œæ·±åº¦å¯¹æ¯”
            if (!leftResp.error && !rightResp.error) {
                const results = deepCompare(leftResp, rightResp);
                renderCompareResults(results);
            } else {
                updateBadge('badge-center', 'error');
                document.getElementById('compare-details').innerHTML = '<p style="color: var(--error);">æ— æ³•å¯¹æ¯”ï¼šè‡³å°‘ä¸€æ–¹è¯·æ±‚å¤±è´¥</p>';
            }
        }

        async function runAllComparisons() {
            const testIds = Object.keys(testConfigs);
            for (const testId of testIds) {
                document.querySelectorAll('.test-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.test-tab[data-test="${testId}"]`).classList.add('active');
                currentTest = testId;
                updateRequestPreview();
                await runComparison();
                await new Promise(r => setTimeout(r, 3000));
            }
        }

        // ========== æµå¼è¾“å‡ºæµ‹è¯• ==========
        async function runStreamingComparison(config, realApiUrl, apiKey, localUrl) {
            // é‡ç½®çŠ¶æ€
            updateBadge('badge-left', 'running');
            updateBadge('badge-right', 'running');
            updateBadge('badge-center', 'comparing');
            document.getElementById('response-left').innerHTML = '<pre>æµå¼è¯·æ±‚ä¸­...</pre>';
            document.getElementById('response-right').innerHTML = '<pre>æµå¼è¯·æ±‚ä¸­...</pre>';
            document.getElementById('compare-details').innerHTML = '<p style="color: var(--text-secondary);">æµå¼å¯¹æ¯”ä¸­...</p>';
            document.getElementById('stats-summary').style.display = 'none';

            // æµå¼è¯·æ±‚å¤„ç†å‡½æ•°
            async function streamRequest(url, isLeft) {
                const outputEl = document.getElementById(isLeft ? 'response-left' : 'response-right');
                const chunks = [];
                let finalResponse = null;

                try {
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config.body)
                    });

                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const text = decoder.decode(value, { stream: true });
                        const lines = text.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    chunks.push(data);
                                    finalResponse = data;

                                    // å®æ—¶æ›´æ–°æ˜¾ç¤º
                                    const displayText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                    outputEl.innerHTML = `<pre style="color: #4caf50;">ğŸ”„ æµå¼è¾“å‡ºä¸­...\n\n${displayText}</pre>`;
                                } catch (e) {}
                            }
                        }
                    }

                    return { chunks, finalResponse };
                } catch (e) {
                    return { error: e.message };
                }
            }

            // å¹¶è¡Œæµå¼è¯·æ±‚
            const leftUrl = `${realApiUrl}/v1beta/models/gemini-3-pro-preview:streamGenerateContent?key=${apiKey}&alt=sse`;
            const rightUrl = `${localUrl}/v1beta/models/gemini-3-pro-preview:streamGenerateContent?alt=sse`;

            const [leftResult, rightResult] = await Promise.all([
                apiKey ? streamRequest(leftUrl, true) : Promise.resolve({ error: 'è¯·è¾“å…¥ API Key' }),
                streamRequest(rightUrl, false)
            ]);

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            if (leftResult.error) {
                updateBadge('badge-left', 'error');
                document.getElementById('response-left').innerHTML = `<pre style="color: #f44336;">é”™è¯¯: ${leftResult.error}</pre>`;
            } else {
                updateBadge('badge-left', 'success');
                document.getElementById('response-left').innerHTML = `<pre>æ”¶åˆ° ${leftResult.chunks.length} ä¸ª chunks\n\næœ€ç»ˆå“åº”:\n${JSON.stringify(leftResult.finalResponse, null, 2)}</pre>`;
            }

            if (rightResult.error) {
                updateBadge('badge-right', 'error');
                document.getElementById('response-right').innerHTML = `<pre style="color: #f44336;">é”™è¯¯: ${rightResult.error}</pre>`;
            } else {
                updateBadge('badge-right', 'success');
                document.getElementById('response-right').innerHTML = `<pre>æ”¶åˆ° ${rightResult.chunks.length} ä¸ª chunks\n\næœ€ç»ˆå“åº”:\n${JSON.stringify(rightResult.finalResponse, null, 2)}</pre>`;
            }

            // æµå¼å¯¹æ¯”ï¼šæ¯”è¾ƒæœ€ç»ˆå“åº”
            if (!leftResult.error && !rightResult.error && leftResult.finalResponse && rightResult.finalResponse) {
                const results = deepCompare(leftResult.finalResponse, rightResult.finalResponse);
                renderCompareResults(results);

                // æ·»åŠ  chunk æ•°é‡å¯¹æ¯”
                const chunkInfo = `
                    <div class="compare-section">
                        <div class="compare-section-title">æµå¼ç»Ÿè®¡</div>
                        <div class="compare-item ${leftResult.chunks.length === rightResult.chunks.length ? 'match' : 'mismatch'}">
                            <span class="compare-icon">${leftResult.chunks.length === rightResult.chunks.length ? 'âœ“' : 'âœ—'}</span>
                            <span class="compare-path">Chunk æ•°é‡ - çœŸå®: ${leftResult.chunks.length}, æœ¬åœ°: ${rightResult.chunks.length}</span>
                        </div>
                    </div>
                `;
                document.getElementById('compare-details').innerHTML = chunkInfo + document.getElementById('compare-details').innerHTML;
            } else {
                updateBadge('badge-center', 'error');
                document.getElementById('compare-details').innerHTML = '<p style="color: var(--error);">æ— æ³•å¯¹æ¯”ï¼šè‡³å°‘ä¸€æ–¹è¯·æ±‚å¤±è´¥</p>';
            }
        }

        // ========== éŸ³é¢‘åŠŸèƒ½ ==========
        let mediaRecorder = null;
        let audioChunks = [];
        let customAudioData = null;
        let testHistory = [];

        // ç›‘å¬æµ‹è¯•é€‰é¡¹å˜åŒ–ï¼Œæ˜¾ç¤º/éšè—éŸ³é¢‘ä¸“åŒº
        function updateAudioSection() {
            const audioSection = document.getElementById('audioTestSection');
            const historySection = document.getElementById('testHistory');
            if (currentTest.startsWith('5-') && currentTest !== '5-1') {
                audioSection.style.display = 'block';
            } else {
                audioSection.style.display = 'none';
            }
            // æ˜¾ç¤ºå†å²è®°å½•
            if (testHistory.length > 0) {
                historySection.style.display = 'block';
                renderHistory();
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('audioFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const arrayBuffer = event.target.result;
                const base64 = btoa(new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));

                customAudioData = {
                    data: base64,
                    mimeType: file.type || 'audio/wav',
                    fileName: file.name,
                    size: file.size
                };

                // æ˜¾ç¤ºé¢„è§ˆ
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = URL.createObjectURL(file);
                document.getElementById('audioInfo').textContent =
                    `æ–‡ä»¶: ${file.name} | å¤§å°: ${(file.size / 1024).toFixed(1)} KB | ç±»å‹: ${file.type}`;
                document.getElementById('audioPreview').style.display = 'block';
                document.getElementById('audioStatus').textContent = 'âœ… éŸ³é¢‘å·²åŠ è½½';
            };
            reader.readAsArrayBuffer(file);
        });

        // å½•éŸ³åŠŸèƒ½
        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const statusEl = document.getElementById('audioStatus');

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // åœæ­¢å½•éŸ³
                mediaRecorder.stop();
                recordBtn.textContent = 'ğŸ”´ å½•éŸ³';
                recordBtn.classList.remove('btn-error');
                statusEl.textContent = 'å¤„ç†ä¸­...';
                statusEl.classList.remove('recording');
            } else {
                // å¼€å§‹å½•éŸ³
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const arrayBuffer = event.target.result;
                            const base64 = btoa(new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));

                            customAudioData = {
                                data: base64,
                                mimeType: 'audio/webm',
                                fileName: 'recording.webm',
                                size: audioBlob.size
                            };

                            // æ˜¾ç¤ºé¢„è§ˆ
                            const audioPlayer = document.getElementById('audioPlayer');
                            audioPlayer.src = URL.createObjectURL(audioBlob);
                            document.getElementById('audioInfo').textContent =
                                `å½•éŸ³ | å¤§å°: ${(audioBlob.size / 1024).toFixed(1)} KB`;
                            document.getElementById('audioPreview').style.display = 'block';
                            statusEl.textContent = 'âœ… å½•éŸ³å®Œæˆ';
                        };
                        reader.readAsArrayBuffer(audioBlob);

                        // åœæ­¢æ‰€æœ‰éŸ³è½¨
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    recordBtn.textContent = 'â¹ åœæ­¢';
                    recordBtn.classList.add('btn-error');
                    statusEl.textContent = 'ğŸ”´ å½•éŸ³ä¸­...';
                    statusEl.classList.add('recording');
                } catch (err) {
                    statusEl.textContent = 'âŒ æ— æ³•è®¿é—®éº¦å…‹é£';
                    console.error('Recording error:', err);
                }
            }
        }

        // è¿è¡Œè‡ªå®šä¹‰éŸ³é¢‘æµ‹è¯•
        async function runCustomAudioTest() {
            if (!customAudioData) {
                alert('è¯·å…ˆä¸Šä¼ æˆ–å½•åˆ¶éŸ³é¢‘');
                return;
            }

            const prompt = document.getElementById('customAudioPrompt').value;
            const localUrl = document.getElementById('localUrl').value;

            // æ„å»ºè¯·æ±‚
            const requestBody = {
                "contents": [{"role": "user", "parts": [
                    {"text": prompt},
                    {"inlineData": {"mimeType": customAudioData.mimeType, "data": customAudioData.data}}
                ]}],
                "generationConfig": {"maxOutputTokens": 1024}
            };

            // æ›´æ–°é¢„è§ˆ
            document.getElementById('requestPreview').textContent = JSON.stringify({
                ...requestBody,
                contents: [{...requestBody.contents[0], parts: [
                    requestBody.contents[0].parts[0],
                    {inlineData: {mimeType: customAudioData.mimeType, data: `[${customAudioData.fileName}, ${(customAudioData.size/1024).toFixed(1)}KB]`}}
                ]}]
            }, null, 2);

            // è¿è¡Œæµ‹è¯•
            updateBadge('badge-right', 'running');
            document.getElementById('response-right').innerHTML = '<pre>éŸ³é¢‘å¤„ç†ä¸­... (å¯èƒ½éœ€è¦30-60ç§’)</pre>';

            const startTime = Date.now();
            try {
                const resp = await fetch(`${localUrl}/v1beta/models/gemini-3-pro-preview:generateContent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await resp.json();
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

                if (data.error) {
                    updateBadge('badge-right', 'error');
                    document.getElementById('response-right').innerHTML = `<pre style="color: #f44336;">é”™è¯¯: ${JSON.stringify(data.error, null, 2)}</pre>`;
                    addToHistory('è‡ªå®šä¹‰éŸ³é¢‘', false, elapsed);
                } else {
                    updateBadge('badge-right', 'success');
                    document.getElementById('response-right').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    addToHistory('è‡ªå®šä¹‰éŸ³é¢‘', true, elapsed);
                }
            } catch (err) {
                updateBadge('badge-right', 'error');
                document.getElementById('response-right').innerHTML = `<pre style="color: #f44336;">ç½‘ç»œé”™è¯¯: ${err.message}</pre>`;
                addToHistory('è‡ªå®šä¹‰éŸ³é¢‘', false, '0');
            }
        }

        // æµ‹è¯•å†å²ç®¡ç†
        function addToHistory(testName, passed, duration) {
            testHistory.unshift({
                name: testName,
                passed: passed,
                time: new Date().toLocaleTimeString(),
                duration: duration + 's'
            });
            if (testHistory.length > 20) testHistory.pop();

            document.getElementById('testHistory').style.display = 'block';
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = testHistory.map(h => `
                <div class="history-item ${h.passed ? 'pass' : 'fail'}">
                    <span>${h.passed ? 'âœ“' : 'âœ—'} ${h.name}</span>
                    <span class="history-time">${h.time} (${h.duration})</span>
                </div>
            `).join('');
        }

        function clearHistory() {
            testHistory = [];
            document.getElementById('testHistory').style.display = 'none';
        }

        // ä¿®æ”¹åŸæœ‰çš„æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.test-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.test-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTest = tab.dataset.test;
                updateRequestPreview();
                updateAudioSection();
            });
        });

        // å¢å¼º runComparison ä»¥è®°å½•å†å²
        const originalRunComparison = runComparison;
        runComparison = async function() {
            const startTime = Date.now();
            await originalRunComparison();
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

            // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
            const leftBadge = document.getElementById('badge-left').textContent;
            const rightBadge = document.getElementById('badge-right').textContent;
            const passed = leftBadge === 'æˆåŠŸ' && rightBadge === 'æˆåŠŸ';

            addToHistory(testConfigs[currentTest].name, passed, elapsed);
        };

        // åˆå§‹åŒ–
        updateRequestPreview();
        updateAudioSection();
    </script>
</body>
</html>
